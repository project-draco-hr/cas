{
  updateModelMap(model,request);
  this.validator.validate(service,result);
  if (result.hasErrors()) {
    model.addAttribute("validationErrors",result.getAllErrors());
    return render(request,model);
  }
  RegisteredService svcToUse=service;
  if (service.getServiceId().startsWith("^") && service instanceof RegisteredServiceImpl) {
    LOGGER.debug("Detected regular expression starting with ^");
    final RegexRegisteredService regexService=new RegexRegisteredService();
    regexService.copyFrom(service);
    svcToUse=regexService;
  }
 else   if (!service.getServiceId().startsWith("^") && service instanceof RegexRegisteredService) {
    LOGGER.debug("Detected ant expression {}",service.getServiceId());
    final RegisteredServiceImpl regexService=new RegisteredServiceImpl();
    regexService.copyFrom(service);
    svcToUse=regexService;
  }
  this.servicesManager.save(svcToUse);
  LOGGER.info("Saved changes to service {}",svcToUse.getId());
  final ModelAndView modelAndView=new ModelAndView(new RedirectView("manage.html#" + svcToUse.getId(),true));
  modelAndView.addObject("action","add");
  modelAndView.addObject("id",svcToUse.getId());
  return modelAndView;
}
