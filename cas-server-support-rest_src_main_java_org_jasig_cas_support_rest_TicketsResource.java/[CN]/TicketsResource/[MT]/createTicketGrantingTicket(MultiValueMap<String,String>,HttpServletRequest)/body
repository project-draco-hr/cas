{
  try (Formatter fmt=new Formatter()){
    final Credential credential=this.credentialFactory.fromRequestBody(requestBody);
    final AuthenticationContext authenticationContext=this.authenticationSystemSupport.handleFinalizedAuthenticationAttempt(null,credential);
    final TicketGrantingTicket tgtId=this.centralAuthenticationService.createTicketGrantingTicket(authenticationContext);
    final URI ticketReference=new URI(request.getRequestURL().toString() + '/' + tgtId.getId());
    final HttpHeaders headers=new HttpHeaders();
    headers.setLocation(ticketReference);
    headers.setContentType(MediaType.TEXT_HTML);
    fmt.format("<!DOCTYPE HTML PUBLIC \\\"-//IETF//DTD HTML 2.0//EN\\\"><html><head><title>");
    fmt.format("%s %s",HttpStatus.CREATED,HttpStatus.CREATED.getReasonPhrase()).format("</title></head><body><h1>TGT Created</h1><form action=\"%s",ticketReference.toString()).format("\" method=\"POST\">Service:<input type=\"text\" name=\"service\" value=\"\">").format("<br><input type=\"submit\" value=\"Submit\"></form></body></html>");
    return new ResponseEntity<>(fmt.toString(),headers,HttpStatus.CREATED);
  }
 catch (  final AuthenticationException e) {
    final List<String> authnExceptions=new LinkedList<>();
    for (    final Map.Entry<String,Class<? extends Exception>> handlerErrorEntry : e.getHandlerErrors().entrySet()) {
      authnExceptions.add(handlerErrorEntry.getValue().getSimpleName());
    }
    final Map<String,List<String>> errorsMap=new HashMap<>();
    errorsMap.put("authentication_exceptions",authnExceptions);
    LOGGER.error(e.getMessage(),e);
    LOGGER.error(String.format("Caused by: %s",authnExceptions));
    return new ResponseEntity<>(this.jacksonObjectMapper.writer().withDefaultPrettyPrinter().writeValueAsString(errorsMap),HttpStatus.UNAUTHORIZED);
  }
catch (  final BadRequestException e) {
    LOGGER.error(e.getMessage(),e);
    return new ResponseEntity<>(e.getMessage(),HttpStatus.BAD_REQUEST);
  }
catch (  final Throwable e) {
    LOGGER.error(e.getMessage(),e);
    return new ResponseEntity<>(e.getMessage(),HttpStatus.INTERNAL_SERVER_ERROR);
  }
}
