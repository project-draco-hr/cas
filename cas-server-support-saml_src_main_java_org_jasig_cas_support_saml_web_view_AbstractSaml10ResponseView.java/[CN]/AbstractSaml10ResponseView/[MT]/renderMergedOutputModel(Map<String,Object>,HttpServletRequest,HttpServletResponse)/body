{
  response.setCharacterEncoding(this.encoding);
  final WebApplicationService service=this.samlArgumentExtractor.extractService(request);
  final String serviceId=service != null ? service.getId() : "UNKNOWN";
  try {
    final Response samlResponse=this.samlObjectBuilder.newResponse(generateId(),this.skewAllowance,serviceId,service);
    prepareResponse(samlResponse,model);
    final BasicSAMLMessageContext messageContext=new BasicSAMLMessageContext();
    messageContext.setOutboundMessageTransport(new HttpServletResponseAdapter(response,request.isSecure()));
    messageContext.setOutboundSAMLMessage(samlResponse);
    this.encoder.encode(messageContext);
  }
 catch (  final Exception e) {
    logger.error("Error generating SAML response for service {}.",serviceId);
    throw e;
  }
}
