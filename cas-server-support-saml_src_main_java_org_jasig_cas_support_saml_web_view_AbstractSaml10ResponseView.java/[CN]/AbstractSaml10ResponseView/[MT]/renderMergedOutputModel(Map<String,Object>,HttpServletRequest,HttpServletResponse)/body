{
  response.setCharacterEncoding(this.encoding);
  final WebApplicationService service=this.samlArgumentExtractor.extractService(request);
  final String serviceId=service != null ? service.getId() : "UNKNOWN";
  try {
    final Response samlResponse=this.samlObjectBuilder.newResponse(this.samlObjectBuilder.generateSecureRandomId(),DateTime.now().minusSeconds(this.skewAllowance),serviceId,service);
    prepareResponse(samlResponse,model);
    this.samlObjectBuilder.encodeSamlResponse(response,request,samlResponse);
  }
 catch (  final Exception e) {
    logger.error("Error generating SAML response for service {}.",serviceId);
    throw e;
  }
}
