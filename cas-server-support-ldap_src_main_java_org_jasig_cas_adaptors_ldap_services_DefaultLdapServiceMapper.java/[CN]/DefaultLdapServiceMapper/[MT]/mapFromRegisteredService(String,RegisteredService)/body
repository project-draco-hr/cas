{
  try {
    if (svc.getId() == RegisteredService.INITIAL_IDENTIFIER_VALUE) {
      ((AbstractRegisteredService)svc).setId(System.nanoTime());
    }
    final String newDn=getDnForRegisteredService(dn,svc);
    LOGGER.debug("Creating entry {}",newDn);
    final Collection<LdapAttribute> attrs=new ArrayList<LdapAttribute>();
    attrs.add(new LdapAttribute(this.idAttribute,String.valueOf(svc.getId())));
    attrs.add(new LdapAttribute(this.serviceIdAttribute,svc.getServiceId()));
    attrs.add(new LdapAttribute(this.serviceNameAttribute,svc.getName()));
    attrs.add(new LdapAttribute(this.serviceDescriptionAttribute,svc.getDescription()));
    attrs.add(new LdapAttribute(this.serviceEnabledAttribute,Boolean.toString(svc.isEnabled()).toUpperCase()));
    attrs.add(new LdapAttribute(this.serviceSsoEnabledAttribute,Boolean.toString(svc.isSsoEnabled()).toUpperCase()));
    attrs.add(new LdapAttribute(this.evaluationOrderAttribute,String.valueOf(svc.getEvaluationOrder())));
    attrs.add(new LdapAttribute(this.serviceThemeAttribute,svc.getTheme()));
    if (svc.getUsernameAttributeProvider() != null) {
      final RegisteredServiceUsernameAttributeProviderJsonSerializer mapper=new RegisteredServiceUsernameAttributeProviderJsonSerializer();
      final Writer writer=new StringWriter();
      mapper.toJson(writer,svc.getUsernameAttributeProvider());
      final LdapAttribute attr=new LdapAttribute(this.usernameAttributeProvider,writer.toString());
      attrs.add(attr);
    }
    if (svc.getProxyPolicy() != null) {
      final RegisteredServiceProxyPolicyJsonSerializer mapper=new RegisteredServiceProxyPolicyJsonSerializer();
      final Writer writer=new StringWriter();
      mapper.toJson(writer,svc.getProxyPolicy());
      final LdapAttribute attr=new LdapAttribute(this.serviceProxyPolicyAttribute,writer.toString());
      attrs.add(attr);
    }
    if (svc.getAttributeReleasePolicy() != null) {
      final AttributeReleasePolicyJsonSerializer mapper=new AttributeReleasePolicyJsonSerializer();
      final Writer writer=new StringWriter();
      mapper.toJson(writer,svc.getAttributeReleasePolicy());
      final LdapAttribute attr=new LdapAttribute(this.attributeReleasePolicyAttribute,writer.toString());
      attrs.add(attr);
    }
    if (svc.getRequiredHandlers().size() > 0) {
      attrs.add(new LdapAttribute(this.requiredHandlersAttribute,svc.getRequiredHandlers().toArray(new String[]{})));
    }
    attrs.add(new LdapAttribute(LdapUtils.OBJECTCLASS_ATTRIBUTE,"top",this.objectClass));
    return new LdapEntry(newDn,attrs);
  }
 catch (  final Exception e) {
    throw new RuntimeException(e);
  }
}
