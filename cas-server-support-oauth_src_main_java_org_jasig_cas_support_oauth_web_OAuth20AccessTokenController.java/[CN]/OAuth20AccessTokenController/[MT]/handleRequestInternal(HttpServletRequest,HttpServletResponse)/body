{
  final String redirectUri=request.getParameter(OAuthConstants.REDIRECT_URI);
  log.debug("{} : {}",OAuthConstants.REDIRECT_URI,redirectUri);
  final String clientId=request.getParameter(OAuthConstants.CLIENT_ID);
  log.debug("{} : {}",OAuthConstants.CLIENT_ID,clientId);
  final String clientSecret=request.getParameter(OAuthConstants.CLIENT_SECRET);
  final String code=request.getParameter(OAuthConstants.CODE);
  log.debug("{} : {}",OAuthConstants.CODE,code);
  final boolean isVerified=verifyAccessTokenRequest(response,redirectUri,clientId,clientSecret,code);
  if (!isVerified) {
    return OAuthUtils.writeTextError(response,OAuthConstants.INVALID_REQUEST,400);
  }
  final ServiceTicket serviceTicket=(ServiceTicket)ticketRegistry.getTicket(code);
  if (serviceTicket == null || serviceTicket.isExpired()) {
    log.error("Code expired : {}",code);
    return OAuthUtils.writeTextError(response,OAuthConstants.INVALID_GRANT,400);
  }
  final TicketGrantingTicket ticketGrantingTicket=serviceTicket.getGrantingTicket();
  ticketRegistry.deleteTicket(serviceTicket.getId());
  response.setContentType("text/plain");
  final int expires=(int)(timeout - (System.currentTimeMillis() - ticketGrantingTicket.getCreationTime()) / 1000);
  final String text=String.format("%s=%s&%s=%s",OAuthConstants.ACCESS_TOKEN,ticketGrantingTicket.getId(),OAuthConstants.EXPIRES,expires);
  log.debug("text : {}",text);
  return OAuthUtils.writeText(response,text,200);
}
