{
  final String redirectUri=request.getParameter(OAuthConstants.REDIRECT_URI);
  log.debug("redirect_uri : {}",redirectUri);
  final String clientId=request.getParameter(OAuthConstants.CLIENT_ID);
  log.debug("clientId : {}",clientId);
  final String clientSecret=request.getParameter(OAuthConstants.CLIENT_SECRET);
  log.debug("clientSecret : {}",clientSecret);
  final String code=request.getParameter(OAuthConstants.CODE);
  log.debug("code : {}",clientSecret);
  if (StringUtils.isBlank(clientId)) {
    log.error("missing clientId");
    return OAuthUtils.writeTextError(response,OAuthConstants.INVALID_REQUEST,400);
  }
  if (StringUtils.isBlank(redirectUri)) {
    log.error("missing redirectUri");
    return OAuthUtils.writeTextError(response,OAuthConstants.INVALID_REQUEST,400);
  }
  if (StringUtils.isBlank(clientSecret)) {
    log.error("missing clientSecret");
    return OAuthUtils.writeTextError(response,OAuthConstants.INVALID_REQUEST,400);
  }
  if (StringUtils.isBlank(code)) {
    log.error("missing code");
    return OAuthUtils.writeTextError(response,OAuthConstants.INVALID_REQUEST,400);
  }
  final Collection<RegisteredService> services=servicesManager.getAllServices();
  RegisteredService service=null;
  for (  final RegisteredService aService : services) {
    if (StringUtils.equals(aService.getName(),clientId)) {
      service=aService;
      break;
    }
  }
  if (service == null) {
    log.error("Unknown clientId : {}",clientId);
    return OAuthUtils.writeTextError(response,OAuthConstants.INVALID_REQUEST,400);
  }
  final String serviceId=service.getServiceId();
  if (!StringUtils.startsWith(redirectUri,serviceId)) {
    log.error("Unsupported redirectUri : {} for serviceId : {}",redirectUri,serviceId);
    return OAuthUtils.writeTextError(response,OAuthConstants.INVALID_REQUEST,400);
  }
  final String serviceDescription=service.getDescription();
  if (!StringUtils.equals(serviceDescription,clientSecret)) {
    log.error("Wrong client secret : {} for service description : {}",clientSecret,serviceDescription);
    return OAuthUtils.writeTextError(response,OAuthConstants.INVALID_REQUEST,400);
  }
  final ServiceTicket serviceTicket=(ServiceTicket)ticketRegistry.getTicket(code);
  if (serviceTicket == null || serviceTicket.isExpired()) {
    log.error("Code expired : {}",code);
    return OAuthUtils.writeTextError(response,OAuthConstants.INVALID_GRANT,400);
  }
  final TicketGrantingTicket ticketGrantingTicket=serviceTicket.getGrantingTicket();
  ticketRegistry.deleteTicket(serviceTicket.getId());
  response.setContentType("text/plain");
  final int expires=(int)(timeout - (System.currentTimeMillis() - ticketGrantingTicket.getCreationTime()) / 1000);
  final String text="access_token=" + ticketGrantingTicket.getId() + "&expires="+ expires;
  log.debug("text : {}",text);
  return OAuthUtils.writeText(response,text,200);
}
