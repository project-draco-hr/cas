{
  String accessToken=request.getParameter(OAuthConstants.ACCESS_TOKEN);
  if (StringUtils.isBlank(accessToken)) {
    final String authHeader=request.getHeader("Authorization");
    if (StringUtils.isNotBlank(authHeader) && authHeader.toLowerCase().startsWith(OAuthConstants.BEARER_TOKEN.toLowerCase() + " ")) {
      accessToken=authHeader.substring(OAuthConstants.BEARER_TOKEN.length() + 1);
    }
  }
  LOGGER.debug("{} : {}",OAuthConstants.ACCESS_TOKEN,accessToken);
  try (final JsonGenerator jsonGenerator=this.jsonFactory.createJsonGenerator(response.getWriter())){
    response.setContentType("application/json");
    if (StringUtils.isBlank(accessToken)) {
      LOGGER.error("Missing {}",OAuthConstants.ACCESS_TOKEN);
      jsonGenerator.writeStartObject();
      jsonGenerator.writeStringField("error",OAuthConstants.MISSING_ACCESS_TOKEN);
      jsonGenerator.writeEndObject();
      return null;
    }
    final TicketGrantingTicket ticketGrantingTicket=(TicketGrantingTicket)this.ticketRegistry.getTicket(accessToken);
    if (ticketGrantingTicket == null || ticketGrantingTicket.isExpired()) {
      LOGGER.error("expired accessToken : {}",accessToken);
      jsonGenerator.writeStartObject();
      jsonGenerator.writeStringField("error",OAuthConstants.EXPIRED_ACCESS_TOKEN);
      jsonGenerator.writeEndObject();
      return null;
    }
    final Principal principal=ticketGrantingTicket.getAuthentication().getPrincipal();
    jsonGenerator.writeStartObject();
    jsonGenerator.writeStringField(ID,principal.getId());
    jsonGenerator.writeArrayFieldStart(ATTRIBUTES);
    final Map<String,Object> attributes=principal.getAttributes();
    for (    final Map.Entry<String,Object> entry : attributes.entrySet()) {
      jsonGenerator.writeStartObject();
      jsonGenerator.writeObjectField(entry.getKey(),entry.getValue());
      jsonGenerator.writeEndObject();
    }
    jsonGenerator.writeEndArray();
    jsonGenerator.writeEndObject();
    return null;
  }
  finally {
    response.flushBuffer();
  }
}
