{
  String accessToken=request.getParameter(OAuthConstants.ACCESS_TOKEN);
  logger.debug("accessToken : {}",accessToken);
  JsonFactory jsonFactory=new JsonFactory();
  JsonGenerator jsonGenerator=jsonFactory.createJsonGenerator(response.getWriter());
  if (StringUtils.isBlank(accessToken)) {
    logger.error("missing accessToken");
    jsonGenerator.writeStartObject();
    jsonGenerator.writeStringField("error",OAuthConstants.MISSING_ACCESS_TOKEN);
    jsonGenerator.writeEndObject();
    jsonGenerator.close();
    response.flushBuffer();
    return null;
  }
  TicketGrantingTicketImpl ticketGrantingTicketImpl=(TicketGrantingTicketImpl)ticketRegistry.getTicket(accessToken);
  if (ticketGrantingTicketImpl == null || ticketGrantingTicketImpl.isExpired()) {
    logger.error("expired accessToken : {}",accessToken);
    jsonGenerator.writeStartObject();
    jsonGenerator.writeStringField("error",OAuthConstants.EXPIRED_ACCESS_TOKEN);
    jsonGenerator.writeEndObject();
    jsonGenerator.close();
    response.flushBuffer();
    return null;
  }
  Principal principal=ticketGrantingTicketImpl.getAuthentication().getPrincipal();
  jsonGenerator.writeStartObject();
  jsonGenerator.writeStringField(CasWrapperProfile.ID,principal.getId());
  jsonGenerator.writeArrayFieldStart(CasWrapperProfile.ATTRIBUTES);
  Map<String,Object> attributes=principal.getAttributes();
  for (  String key : attributes.keySet()) {
    jsonGenerator.writeStartObject();
    jsonGenerator.writeObjectField(key,attributes.get(key));
    jsonGenerator.writeEndObject();
  }
  jsonGenerator.writeEndArray();
  jsonGenerator.writeEndObject();
  jsonGenerator.close();
  response.flushBuffer();
  return null;
}
