{
  final Class<? extends Credentials> credentialsClass=credentials.getClass();
  final DirectAuthenticationHandlerMappingHolder d=this.credentialsMapping.get(credentialsClass);
  Assert.notNull(d,"no mapping found for: " + credentialsClass.getName());
  boolean authenticated=false;
  final LoggingStopWatch stopWatch=new LoggingStopWatch(d.getAuthenticationHandler().getClass().getSimpleName());
  try {
    authenticated=d.getAuthenticationHandler().authenticate(credentials);
  }
  finally {
    stopWatch.stop();
  }
  if (!authenticated) {
    throw new BadCredentialsAuthenticationException();
  }
  final Principal p=d.getCredentialsToPrincipalResolver().resolvePrincipal(credentials);
  return new Pair<AuthenticationHandler,Principal>(d.getAuthenticationHandler(),p);
}
