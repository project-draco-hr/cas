{
  final Class<? extends Credentials> credentialsClass=credentials.getClass();
  final DirectAuthenticationHandlerMappingHolder d=this.credentialsMapping.get(credentialsClass);
  Assert.notNull(d,"no mapping found for: " + credentialsClass.getName());
  final String handlerName=d.getAuthenticationHandler().getClass().getSimpleName();
  boolean authenticated=false;
  AuthenticationException authException=BadCredentialsAuthenticationException.ERROR;
  try {
    authenticated=d.getAuthenticationHandler().authenticate(credentials);
  }
 catch (  AuthenticationException e) {
    authException=e;
    logAuthenticationHandlerError(handlerName,credentials,e);
  }
catch (  Exception e) {
    logAuthenticationHandlerError(handlerName,credentials,e);
  }
  if (!authenticated) {
    log.info("{} failed to authenticate {}",handlerName,credentials);
    throw authException;
  }
  log.info("{} successfully authenticated {}",handlerName,credentials);
  final Principal p=d.getCredentialsToPrincipalResolver().resolvePrincipal(credentials);
  return new Pair<AuthenticationHandler,Principal>(d.getAuthenticationHandler(),p);
}
