{
  if (credential == null) {
    return;
  }
  final HttpServletResponse response=WebUtils.getHttpServletResponse(context);
  final SpnegoCredential spnegoCredentials=(SpnegoCredential)credential;
  final byte[] nextToken=spnegoCredentials.getNextToken();
  if (nextToken != null) {
    if (logger.isDebugEnabled()) {
      logger.debug("Obtained output token: " + new String(nextToken));
    }
    response.setHeader(SpnegoConstants.HEADER_AUTHENTICATE,(this.ntlm ? SpnegoConstants.NTLM : SpnegoConstants.NEGOTIATE) + " " + Base64.encode(nextToken));
  }
 else {
    logger.debug("Unable to obtain the output token required.");
  }
  if (spnegoCredentials.getPrincipal() == null && send401OnAuthenticationFailure) {
    logger.debug("Setting HTTP Status to 401");
    response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
  }
}
