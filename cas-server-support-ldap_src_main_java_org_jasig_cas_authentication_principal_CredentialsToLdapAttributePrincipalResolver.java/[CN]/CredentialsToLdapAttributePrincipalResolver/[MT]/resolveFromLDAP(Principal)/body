{
  final SearchResult result;
  try {
    logger.debug("Attempting to resolve LDAP principal for {}.",resolvedPrincipal);
    final Set<String> attributesToReturn=new HashSet<String>(this.attributeMapping.keySet());
    attributesToReturn.add(usernameAttribute);
    final String[] attrs=attributesToReturn.toArray(new String[]{});
    final Response<SearchResult> response=searchExecutor.search(connectionFactory,createSearchFilter(resolvedPrincipal),attrs);
    logger.debug("LDAP response: {}",response);
    result=response.getResult();
  }
 catch (  final LdapException e) {
    logger.error("LDAP error resolving principal from {}.",resolvedPrincipal,e);
    return null;
  }
  if (result.getEntries().size() > 1 && !allowMultipleResults) {
    throw new IllegalStateException("Multiple search results found but not allowed.");
  }
  final Principal ldapPrincipal;
  if (result.getEntries().isEmpty()) {
    logger.debug("No results found for {}.",resolvedPrincipal);
    ldapPrincipal=null;
  }
 else {
    ldapPrincipal=principalFromEntry(result.getEntry());
  }
  logger.debug("Resolved principal {}",ldapPrincipal);
  return ldapPrincipal;
}
