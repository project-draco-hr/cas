{
  final Service service=WebUtils.getService(context);
  final String ticketGrantingTicket=WebUtils.getTicketGrantingTicketId(context);
  try {
    final Credential credential=WebUtils.getCredential(context);
    final AuthenticationContextBuilder builder=new DefaultAuthenticationContextBuilder(this.authenticationSystemSupport.getPrincipalElectionStrategy());
    final AuthenticationTransaction transaction=AuthenticationTransaction.wrap(credential);
    this.authenticationSystemSupport.getAuthenticationTransactionManager().handle(transaction,builder);
    final AuthenticationContext authenticationContext=builder.build(service);
    final ServiceTicket serviceTicketId=this.centralAuthenticationService.grantServiceTicket(ticketGrantingTicket,service,authenticationContext);
    WebUtils.putServiceTicketInRequestScope(context,serviceTicketId);
    return success();
  }
 catch (  final AuthenticationException e) {
    logger.error("Could not verify credentials to grant service ticket",e);
  }
catch (  final AbstractTicketException e) {
    if (e instanceof InvalidTicketException) {
      this.centralAuthenticationService.destroyTicketGrantingTicket(ticketGrantingTicket);
    }
    if (isGatewayPresent(context)) {
      return result("gateway");
    }
  }
  return error();
}
