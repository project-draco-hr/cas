{
  try {
    final AbstractRegisteredService regSvc;
    if (StringUtils.equalsIgnoreCase(this.type,RegisteredServiceTypeEditBean.OAUTH_CALLBACK_AUTHZ.toString())) {
      regSvc=new OAuthRegisteredCallbackAuthorizeService();
    }
 else     if (StringUtils.equalsIgnoreCase(this.type,RegisteredServiceTypeEditBean.OAUTH.toString())) {
      regSvc=new OAuthRegisteredService();
      final RegisteredServiceOAuthTypeEditBean oauthBean=this.oauth;
      ((OAuthRegisteredService)regSvc).setClientId(oauthBean.getClientId());
      ((OAuthRegisteredService)regSvc).setClientSecret(oauthBean.getClientSecret());
      ((OAuthRegisteredService)regSvc).setBypassApprovalPrompt(oauthBean.isBypass());
    }
 else {
      regSvc=determineServiceTypeByPattern(this.serviceId);
    }
    regSvc.setId(this.assignedId);
    regSvc.setServiceId(this.serviceId);
    regSvc.setName(this.name);
    regSvc.setDescription(this.description);
    if (StringUtils.isNotBlank(this.logoUrl)) {
      regSvc.setLogo(new URL(this.logoUrl));
    }
    regSvc.setTheme(this.theme);
    regSvc.setEvaluationOrder(this.evalOrder);
    regSvc.setRequiredHandlers(this.requiredHandlers);
    if (StringUtils.equalsIgnoreCase(this.logoutType,RegisteredServiceLogoutTypeEditBean.BACK.toString())) {
      regSvc.setLogoutType(LogoutType.BACK_CHANNEL);
    }
 else     if (StringUtils.equalsIgnoreCase(this.logoutType,RegisteredServiceLogoutTypeEditBean.FRONT.toString())) {
      regSvc.setLogoutType(LogoutType.FRONT_CHANNEL);
    }
 else {
      regSvc.setLogoutType(LogoutType.NONE);
    }
    if (StringUtils.isNotBlank(this.logoutUrl)) {
      regSvc.setLogoutUrl(new URL(this.logoutUrl));
    }
    final RegisteredServiceAccessStrategy accessStrategy=regSvc.getAccessStrategy();
    ((DefaultRegisteredServiceAccessStrategy)accessStrategy).setEnabled(this.supportAccess.isCasEnabled());
    ((DefaultRegisteredServiceAccessStrategy)accessStrategy).setSsoEnabled(this.supportAccess.isSsoEnabled());
    ((DefaultRegisteredServiceAccessStrategy)accessStrategy).setRequireAllAttributes(this.supportAccess.isRequireAll());
    ((DefaultRegisteredServiceAccessStrategy)accessStrategy).setRequiredAttributes(this.supportAccess.getRequiredAttr());
    final String proxyType=this.proxyPolicy.getType();
    if (StringUtils.equalsIgnoreCase(proxyType,RegisteredServiceProxyPolicyBean.Types.REFUSE.toString())) {
      regSvc.setProxyPolicy(new RefuseRegisteredServiceProxyPolicy());
    }
 else     if (StringUtils.equalsIgnoreCase(proxyType,RegisteredServiceProxyPolicyBean.Types.REGEX.toString())) {
      final String value=this.proxyPolicy.getValue();
      if (StringUtils.isNotBlank(value) && isValidRegex(value)) {
        regSvc.setProxyPolicy(new RegexMatchingRegisteredServiceProxyPolicy(value));
      }
 else {
        throw new IllegalArgumentException("Invalid regex pattern specified for proxy policy: " + value);
      }
    }
    final String uidType=this.userAttrProvider.getType();
    if (StringUtils.equalsIgnoreCase(uidType,RegisteredServiceUsernameAttributeProviderEditBean.Types.DEFAULT.toString())) {
      regSvc.setUsernameAttributeProvider(new DefaultRegisteredServiceUsernameProvider());
    }
 else     if (StringUtils.equalsIgnoreCase(uidType,RegisteredServiceUsernameAttributeProviderEditBean.Types.ANONYMOUS.toString())) {
      final String salt=this.userAttrProvider.getValue();
      if (StringUtils.isNotBlank(salt)) {
        final ShibbolethCompatiblePersistentIdGenerator generator=new ShibbolethCompatiblePersistentIdGenerator(salt);
        regSvc.setUsernameAttributeProvider(new AnonymousRegisteredServiceUsernameAttributeProvider(generator));
      }
 else {
        throw new IllegalArgumentException("Invalid sale value for anonymous ids " + salt);
      }
    }
 else     if (StringUtils.equalsIgnoreCase(uidType,RegisteredServiceUsernameAttributeProviderEditBean.Types.ATTRIBUTE.toString())) {
      regSvc.setUsernameAttributeProvider(new PrincipalAttributeRegisteredServiceUsernameProvider(this.userAttrProvider.getValue()));
    }
    if (this.publicKey != null && this.publicKey.isValid()) {
      final RegisteredServicePublicKey publicKey=new RegisteredServicePublicKeyImpl(this.publicKey.getLocation(),this.publicKey.getAlgorithm());
      regSvc.setPublicKey(publicKey);
    }
    final RegisteredServiceAttributeReleasePolicyStrategyEditBean policyBean=this.attrRelease.getAttrPolicy();
    final String policyType=policyBean.getType();
    AbstractAttributeReleasePolicy policy=null;
    if (StringUtils.equalsIgnoreCase(policyType,AbstractRegisteredServiceAttributeReleasePolicyStrategyBean.Types.ALL.toString())) {
      policy=new ReturnAllAttributeReleasePolicy();
    }
 else     if (StringUtils.equalsIgnoreCase(policyType,AbstractRegisteredServiceAttributeReleasePolicyStrategyBean.Types.ALLOWED.toString())) {
      policy=new ReturnAllowedAttributeReleasePolicy((List)policyBean.getAttributes());
    }
 else     if (StringUtils.equalsIgnoreCase(policyType,AbstractRegisteredServiceAttributeReleasePolicyStrategyBean.Types.MAPPED.toString())) {
      policy=new ReturnMappedAttributeReleasePolicy((Map)policyBean.getAttributes());
    }
 else {
      policy=new ReturnAllowedAttributeReleasePolicy();
    }
    final String filter=this.attrRelease.getAttrFilter();
    if (StringUtils.isNotBlank(filter)) {
      policy.setAttributeFilter(new RegisteredServiceRegexAttributeFilter(filter));
    }
    final String attrType=this.attrRelease.getAttrOption();
    if (StringUtils.equalsIgnoreCase(attrType,RegisteredServiceAttributeReleasePolicyEditBean.Types.CACHED.toString())) {
      policy.setPrincipalAttributesRepository(new CachingPrincipalAttributesRepository(dao,TimeUnit.valueOf(this.attrRelease.getCachedTimeUnit().toUpperCase()),this.attrRelease.getCachedExpiration()));
    }
 else     if (StringUtils.equalsIgnoreCase(attrType,RegisteredServiceAttributeReleasePolicyEditBean.Types.DEFAULT.toString())) {
      policy.setPrincipalAttributesRepository(new DefaultPrincipalAttributesRepository());
    }
    regSvc.setAttributeReleasePolicy(policy);
    return regSvc;
  }
 catch (  final Exception e) {
    throw new RuntimeException(e);
  }
}
