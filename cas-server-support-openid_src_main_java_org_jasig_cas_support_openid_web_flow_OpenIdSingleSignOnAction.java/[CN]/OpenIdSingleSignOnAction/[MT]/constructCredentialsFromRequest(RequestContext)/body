{
  final String ticketGrantingTicketId=WebUtils.getTicketGrantingTicketId(context);
  final String openidIdentityParameter=context.getRequestParameters().get("openid.identity");
  String userName=null;
  if (OpenIdUserNameExtractor.SELECT_IDENTIFIER.equals(openidIdentityParameter)) {
    userName=OpenIdUserNameExtractor.SELECT_IDENTIFIER;
    context.getExternalContext().getSessionMap().remove(OPENID_LOCALID);
    if (ticketGrantingTicketId != null) {
      final TicketGrantingTicket tgt=ticketRegistry.getTicket(ticketGrantingTicketId,TicketGrantingTicket.class);
      if (tgt != null && !tgt.isExpired()) {
        userName=tgt.getAuthentication().getPrincipal().getId();
      }
    }
  }
 else {
    userName=this.extractor.extractLocalUsernameFromUri(openidIdentityParameter);
    context.getExternalContext().getSessionMap().put(OPENID_LOCALID,userName);
  }
  final Service service=WebUtils.getService(context);
  if (service instanceof OpenIdService && userName == null) {
    context.getFlowScope().remove("service");
  }
  if (ticketGrantingTicketId == null || userName == null) {
    return null;
  }
  return new OpenIdCredential(ticketGrantingTicketId,userName);
}
