{
  final SpnegoCredentials ntlmCredentials=(SpnegoCredentials)credentials;
  final byte[] src=ntlmCredentials.getInitToken();
  UniAddress dc=null;
  try {
    if (this.loadBalance) {
      if (this.includePattern != null) {
        NbtAddress[] dcs=NbtAddress.getAllByName(this.domainController,0x1C,null,null);
        for (        NbtAddress dc2 : dcs) {
          if (dc2.getHostAddress().matches(this.includePattern)) {
            dc=new UniAddress(dc2);
            break;
          }
        }
      }
 else {
        dc=new UniAddress(NbtAddress.getByName(this.domainController,0x1C,null));
      }
    }
 else {
      dc=UniAddress.getByName(this.domainController,true);
    }
    final byte[] challenge=SmbSession.getChallenge(dc);
switch (src[8]) {
case 1:
      logger.debug("Type 1 received");
    final Type1Message type1=new Type1Message(src);
  final Type2Message type2=new Type2Message(type1,challenge,null);
logger.debug("Type 2 returned. Setting next token.");
ntlmCredentials.setNextToken(type2.toByteArray());
return false;
case 3:
logger.debug("Type 3 received");
final Type3Message type3=new Type3Message(src);
final byte[] lmResponse=type3.getLMResponse() == null ? new byte[0] : type3.getLMResponse();
byte[] ntResponse=type3.getNTResponse() == null ? new byte[0] : type3.getNTResponse();
final NtlmPasswordAuthentication ntlm=new NtlmPasswordAuthentication(type3.getDomain(),type3.getUser(),challenge,lmResponse,ntResponse);
logger.debug("Trying to authenticate {} with domain controller",type3.getUser());
try {
SmbSession.logon(dc,ntlm);
ntlmCredentials.setPrincipal(new SimplePrincipal(type3.getUser()));
return true;
}
 catch (final SmbAuthException sae) {
logger.debug("Authentication failed",sae);
return false;
}
default :
logger.debug("No type code was received");
}
}
 catch (final Exception e) {
logger.error(e.getMessage(),e);
throw new BadCredentialsAuthenticationException(e);
}
return false;
}
