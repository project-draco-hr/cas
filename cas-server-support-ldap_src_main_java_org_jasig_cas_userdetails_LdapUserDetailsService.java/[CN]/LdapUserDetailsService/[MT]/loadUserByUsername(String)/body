{
  final SearchResult userResult;
  try {
    logger.debug("Attempting to get details for user {}.",username);
    final Response<SearchResult> response=this.userSearchExecutor.search(this.connectionFactory,createSearchFilter(this.userSearchExecutor,username));
    logger.debug("LDAP user search response: {}",response);
    userResult=response.getResult();
  }
 catch (  final LdapException e) {
    throw new RuntimeException("LDAP error fetching details for user.",e);
  }
  if (userResult.size() == 0) {
    throw new UsernameNotFoundException(username + " not found.");
  }
  if (userResult.size() > 1 && !this.allowMultipleResults) {
    throw new IllegalStateException("Found multiple results for user which is not allowed (allowMultipleResults=false).");
  }
  final String userDn=userResult.getEntry().getDn();
  final LdapAttribute userAttribute=userResult.getEntry().getAttribute(this.userAttributeName);
  if (userAttribute == null) {
    throw new IllegalStateException(this.userAttributeName + " attribute not found in results.");
  }
  final String id=userAttribute.getStringValue();
  final SearchResult roleResult;
  try {
    logger.debug("Attempting to get roles for user {}.",userDn);
    final Response<SearchResult> response=this.roleSearchExecutor.search(this.connectionFactory,createSearchFilter(this.roleSearchExecutor,userDn));
    logger.debug("LDAP role search response: {}",response);
    roleResult=response.getResult();
  }
 catch (  final LdapException e) {
    throw new RuntimeException("LDAP error fetching roles for user.",e);
  }
  LdapAttribute roleAttribute;
  final Collection<SimpleGrantedAuthority> roles=new ArrayList<>(roleResult.size());
  for (  final LdapEntry entry : roleResult.getEntries()) {
    roleAttribute=entry.getAttribute(this.roleAttributeName);
    if (roleAttribute == null) {
      logger.warn("Role attribute not found on entry {}",entry);
      continue;
    }
    for (    final String role : roleAttribute.getStringValues()) {
      roles.add(new SimpleGrantedAuthority(this.rolePrefix + role.toUpperCase()));
    }
  }
  return new User(id,UNKNOWN_PASSWORD,roles);
}
