{
  final Authentication authentication=getAssertionFrom(model).getChainedAuthentications().get(0);
  final DateTime issuedAt=response.getIssueInstant();
  final Service service=getAssertionFrom(model).getService();
  final boolean isRemembered=(authentication.getAttributes().get(RememberMeCredentials.AUTHENTICATION_ATTRIBUTE_REMEMBER_ME) == Boolean.TRUE && !getAssertionFrom(model).isFromNewLogin());
  final Assertion assertion=newSamlObject(Assertion.class);
  assertion.setID(generateId());
  assertion.setIssueInstant(issuedAt);
  assertion.setIssuer(this.issuer);
  assertion.setConditions(newConditions(issuedAt,service.getId()));
  final AuthenticationStatement authnStatement=newAuthenticationStatement(authentication);
  assertion.getAuthenticationStatements().add(authnStatement);
  final Map<String,Object> attributes=authentication.getPrincipal().getAttributes();
  if (!attributes.isEmpty() || isRemembered) {
    assertion.getAttributeStatements().add(newAttributeStatement(newSubject(authentication.getPrincipal().getId()),attributes,isRemembered));
  }
  response.setStatus(newStatus(StatusCode.SUCCESS,null));
  response.getAssertions().add(assertion);
}
