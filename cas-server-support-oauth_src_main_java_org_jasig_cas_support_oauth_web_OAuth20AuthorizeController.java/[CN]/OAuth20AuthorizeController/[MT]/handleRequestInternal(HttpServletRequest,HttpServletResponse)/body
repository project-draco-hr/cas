{
  final String clientId=request.getParameter(OAuthConstants.CLIENT_ID);
  LOGGER.debug("{} : {}",OAuthConstants.CLIENT_ID,clientId);
  final String redirectUri=request.getParameter(OAuthConstants.REDIRECT_URI);
  LOGGER.debug("{} : {}",OAuthConstants.REDIRECT_URI,redirectUri);
  final String state=request.getParameter(OAuthConstants.STATE);
  LOGGER.debug("{} : {}",OAuthConstants.STATE,state);
  if (StringUtils.isBlank(clientId)) {
    LOGGER.error("Missing {}",OAuthConstants.CLIENT_ID);
    return new ModelAndView(OAuthConstants.ERROR_VIEW);
  }
  if (StringUtils.isBlank(redirectUri)) {
    LOGGER.error("Missing {}",OAuthConstants.REDIRECT_URI);
    return new ModelAndView(OAuthConstants.ERROR_VIEW);
  }
  final OAuthRegisteredService service=OAuthUtils.getRegisteredOAuthService(this.servicesManager,clientId);
  if (service == null) {
    LOGGER.error("Unknown {} : {}",OAuthConstants.CLIENT_ID,clientId);
    return new ModelAndView(OAuthConstants.ERROR_VIEW);
  }
  final String serviceId=service.getServiceId();
  if (!redirectUri.matches(serviceId)) {
    LOGGER.error("Unsupported {} : {} for serviceId : {}",OAuthConstants.REDIRECT_URI,redirectUri,serviceId);
    return new ModelAndView(OAuthConstants.ERROR_VIEW);
  }
  final HttpSession session=request.getSession();
  session.setAttribute(OAuthConstants.OAUTH20_CALLBACKURL,redirectUri);
  session.setAttribute(OAuthConstants.OAUTH20_SERVICE_NAME,service.getName());
  session.setAttribute(OAuthConstants.OAUTH20_STATE,state);
  final String callbackAuthorizeUrl=request.getRequestURL().toString().replace("/" + OAuthConstants.AUTHORIZE_URL,"/" + OAuthConstants.CALLBACK_AUTHORIZE_URL);
  LOGGER.debug("{} : {}",OAuthConstants.CALLBACK_AUTHORIZE_URL,callbackAuthorizeUrl);
  final String loginUrlWithService=OAuthUtils.addParameter(loginUrl,OAuthConstants.SERVICE,callbackAuthorizeUrl);
  LOGGER.debug("loginUrlWithService : {}",loginUrlWithService);
  return OAuthUtils.redirectTo(loginUrlWithService);
}
