{
  final Pair<AuthenticationHandler,Principal> pair=authenticateAndObtainPrincipal(credentials);
  final Principal p=pair.getSecond();
  log.info(String.format("Principal found: %s",p.getId()));
  if (log.isDebugEnabled()) {
    log.debug(String.format("Attribute map for %s: %s",p.getId(),p.getAttributes()));
  }
  Authentication authentication=new MutableAuthentication(p);
  if (pair.getFirst() instanceof NamedAuthenticationHandler) {
    final NamedAuthenticationHandler a=(NamedAuthenticationHandler)pair.getFirst();
    authentication.getAttributes().put(AuthenticationManager.AUTHENTICATION_METHOD_ATTRIBUTE,a.getName());
  }
  for (  final AuthenticationMetaDataPopulator authenticationMetaDataPopulator : this.authenticationMetaDataPopulators) {
    authentication=authenticationMetaDataPopulator.populateAttributes(authentication,credentials);
  }
  return new ImmutableAuthentication(authentication.getPrincipal(),authentication.getAttributes());
}
