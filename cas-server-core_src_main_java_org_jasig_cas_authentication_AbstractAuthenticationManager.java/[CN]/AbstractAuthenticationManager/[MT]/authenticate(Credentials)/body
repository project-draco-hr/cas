{
  final Pair<AuthenticationHandler,Principal> pair=authenticateAndObtainPrincipal(credentials);
  final Principal p=pair.getSecond();
  log.info("Authenticated {} with credential {}.",p,credentials);
  log.debug("Attribute map for {}: {}",p.getId(),p.getAttributes());
  Authentication authentication=new MutableAuthentication(p);
  authentication.getAttributes().put(AuthenticationManager.AUTHENTICATION_METHOD_ATTRIBUTE,pair.getFirst().getName());
  for (  final AuthenticationMetaDataPopulator authenticationMetaDataPopulator : this.authenticationMetaDataPopulators) {
    authentication=authenticationMetaDataPopulator.populateAttributes(authentication,credentials);
  }
  return new ImmutableAuthentication(authentication.getPrincipal(),authentication.getAttributes());
}
