{
  final X509CertificateCredentials x509Credentials=(X509CertificateCredentials)credentials;
  final X509Certificate[] certificates=x509Credentials.getCertificates();
  X509Certificate clientCert=null;
  boolean valid=true;
  boolean hasTrustedIssuer=false;
  for (int i=certificates.length - 1; i >= 0; i--) {
    final X509Certificate certificate=certificates[i];
    try {
      logger.debug("Evaluating {}",CertUtils.toString(certificate));
      validate(certificate);
      if (!hasTrustedIssuer) {
        hasTrustedIssuer=isCertificateFromTrustedIssuer(certificate);
      }
      int pathLength=certificate.getBasicConstraints();
      if (pathLength < 0) {
        logger.debug("Found valid client certificate");
        clientCert=certificate;
      }
 else {
        logger.debug("Found valid CA certificate");
      }
    }
 catch (    final GeneralSecurityException e) {
      logger.warn("Failed to validate {}",CertUtils.toString(certificate),e);
      valid=false;
    }
  }
  if (valid && hasTrustedIssuer && clientCert != null) {
    x509Credentials.setCertificate(clientCert);
    logger.info("Successfully authenticated {}",credentials);
    return true;
  }
  logger.info("Failed to authenticate {}",credentials);
  return false;
}
