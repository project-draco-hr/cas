{
  try {
    final ChainingMetadataResolver metadataManager=new ChainingMetadataResolver();
    metadataManager.setId(ChainingMetadataResolver.class.getCanonicalName());
    final List<MetadataResolver> resolvers=new ArrayList<>(metadataResources.size());
    final Set<Map.Entry<Resource,MetadataFilterChain>> entries=metadataResources.entrySet();
    for (    final Map.Entry<Resource,MetadataFilterChain> entry : entries) {
      final Resource resource=entry.getKey();
      logger.debug("Loading [{}]",resource.getFilename());
      if (!resource.exists() || !resource.isReadable()) {
        logger.warn("Resource [{}] does not exist or cannot be read",resource.getFilename());
        continue;
      }
      final Document inCommonMDDoc;
      try (final InputStream in=resource.getInputStream()){
        logger.debug("Parsing [{}]",resource.getFilename());
        inCommonMDDoc=this.configBean.getParserPool().parse(in);
      }
       final Element metadataRoot=inCommonMDDoc.getDocumentElement();
      final DOMMetadataResolver metadataProvider=new DOMMetadataResolver(metadataRoot);
      metadataProvider.setParserPool(this.configBean.getParserPool());
      metadataProvider.setFailFastInitialization(true);
      metadataProvider.setRequireValidMetadata(this.requireValidMetadata);
      metadataProvider.setId(metadataProvider.getClass().getCanonicalName());
      if (entry.getValue() != null) {
        metadataProvider.setMetadataFilter(entry.getValue());
      }
      logger.debug("Initializing metadata resolver for [{}]",resource.getFilename());
      try {
        metadataProvider.initialize();
        resolvers.add(metadataProvider);
      }
 catch (      final ComponentInitializationException ex) {
        logger.warn("Could not initialize metadata resolver. Resource will be ignored",ex);
      }
    }
    metadataManager.setResolvers(resolvers);
    logger.info("Collected metadata from [{}] resources. Initializing aggregate...",resolvers.size());
    metadataManager.initialize();
    logger.info("Metadata aggregate initialized successfully.",resolvers.size());
    return metadataManager;
  }
 catch (  final Exception ex) {
    throw new RuntimeException(ex.getMessage(),ex);
  }
}
