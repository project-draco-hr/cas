{
  if (this.requiredAttributes.isEmpty()) {
    logger.debug("No required attributes are specified");
    return true;
  }
  if (principalAttributes.isEmpty()) {
    logger.warn("No principal attributes are found to satisfy attribute requirements");
    return false;
  }
  if (principalAttributes.size() < this.requiredAttributes.size()) {
    logger.warn("The size of the principal attributes that are [{}] does not match requirements, " + "which means the principal is not carrying enough data to grant authorization",principalAttributes);
    return false;
  }
  logger.debug("These required attributes [{}] are examined against [{}] before service can proceed.",getRequiredAttributes(),principalAttributes);
  final Sets.SetView<String> difference=Sets.intersection(getRequiredAttributes().keySet(),principalAttributes.keySet());
  final Set<String> copy=difference.immutableCopy();
  if (this.requireAllAttributes && copy.size() < this.requiredAttributes.size()) {
    logger.warn("Not all required attributes are available to the principal");
    return false;
  }
  for (  final String key : copy) {
    final Set<?> requiredValues=this.requiredAttributes.get(key);
    Set<?> availableValues;
    final Object objVal=principalAttributes.get(key);
    if (objVal instanceof Collection) {
      final Collection valCol=(Collection)objVal;
      availableValues=Sets.newHashSet(valCol.toArray());
    }
 else {
      availableValues=Collections.singleton(objVal);
    }
    final Sets.SetView<?> differenceInValues=Sets.intersection(availableValues,requiredValues);
    if (differenceInValues.size() > 0) {
      logger.info("Principal is authorized to access the service");
      return true;
    }
  }
  logger.info("Principal is denied access as the required attributes for the registered service are missing");
  return false;
}
