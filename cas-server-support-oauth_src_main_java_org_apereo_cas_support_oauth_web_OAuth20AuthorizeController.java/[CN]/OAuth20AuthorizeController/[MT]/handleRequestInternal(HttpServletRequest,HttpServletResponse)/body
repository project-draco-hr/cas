{
  if (!verifyAuthorizeRequest(request)) {
    logger.error("Authorize request verification fails");
    return new ModelAndView(OAuthConstants.ERROR_VIEW);
  }
  final String clientId=request.getParameter(OAuthConstants.CLIENT_ID);
  final String redirectUri=request.getParameter(OAuthConstants.REDIRECT_URI);
  logger.debug("Authorize request verification successful for client {} with redirect uri {}",clientId,redirectUri);
  final String bypassApprovalParameter=request.getParameter(OAuthConstants.BYPASS_APPROVAL_PROMPT);
  logger.debug("bypassApprovalParameter: {}",bypassApprovalParameter);
  final OAuthRegisteredService registeredService=OAuthUtils.getRegisteredOAuthService(this.servicesManager,clientId);
  try {
    RegisteredServiceAccessStrategyUtils.ensureServiceAccessIsAllowed(clientId,registeredService);
  }
 catch (  final UnauthorizedServiceException e) {
    logger.error(e.getMessage(),e);
    return new ModelAndView(OAuthConstants.ERROR_VIEW);
  }
  final boolean bypassApprovalService=registeredService != null && registeredService.isBypassApprovalPrompt();
  logger.debug("bypassApprovalService: {}",bypassApprovalService);
  final J2EContext context=new J2EContext(request,response);
  if (bypassApprovalService || bypassApprovalParameter != null) {
    final ProfileManager manager=new ProfileManager(context);
    final UserProfile profile=manager.get(true);
    if (profile == null) {
      logger.error("Unexpected null profile");
      return new ModelAndView(OAuthConstants.ERROR_VIEW);
    }
    final Service service=createService(registeredService);
    final Authentication authentication=createAuthentication(profile,registeredService,context);
    try {
      RegisteredServiceAccessStrategyUtils.ensurePrincipalAccessIsAllowedForService(service,registeredService,authentication);
    }
 catch (    final UnauthorizedServiceException|PrincipalException e) {
      logger.error(e.getMessage(),e);
      return new ModelAndView(OAuthConstants.ERROR_VIEW);
    }
    final String responseType=request.getParameter(OAuthConstants.RESPONSE_TYPE);
    final String callbackUrl;
    if (isResponseType(responseType,OAuthResponseType.CODE)) {
      callbackUrl=buildCallbackUrlForAuthorizationCodeResponseType(authentication,service,redirectUri);
    }
 else {
      callbackUrl=buildCallbackUrlForImplicitResponseType(context,authentication,service,redirectUri);
    }
    logger.debug("callbackUrl: {}",callbackUrl);
    return OAuthUtils.redirectTo(callbackUrl);
  }
  return redirectToApproveView(registeredService,context);
}
