{
  final String relayState=request.getParameter(SamlProtocolConstants.PARAMETER_SAML_RELAY_STATE);
  final String xmlRequest=Saml20ObjectBuilder.decodeSamlAuthnRequest(request.getParameter(SamlProtocolConstants.PARAMETER_SAML_REQUEST));
  if (!StringUtils.hasText(xmlRequest)) {
    return null;
  }
  final Document document=Saml20ObjectBuilder.constructDocumentFromXml(xmlRequest);
  if (document == null) {
    return null;
  }
  final String assertionConsumerServiceUrl=document.getRootElement().getAttributeValue("AssertionConsumerServiceURL");
  final String requestId=document.getRootElement().getAttributeValue("ID");
  return new GoogleAccountsService(assertionConsumerServiceUrl,relayState,requestId,privateKey,publicKey,servicesManager);
}
