{
  String principalId=principal.getId();
  if (principal.getAttributes().containsKey(this.usernameAttribute)) {
    principalId=principal.getAttributes().get(this.usernameAttribute).toString();
  }
 else {
    logger.warn("Principal [{}] did not have attribute [{}] among attributes [{}] so CAS cannot " + "provide the user attribute the service expects. " + "CAS will instead return the default principal id [{}]",principalId,this.usernameAttribute,principal.getAttributes(),principalId);
  }
  logger.debug("Principal id to return is [{}]. The default principal id is [{}].",principalId,principal.getId());
  return principalId;
}
