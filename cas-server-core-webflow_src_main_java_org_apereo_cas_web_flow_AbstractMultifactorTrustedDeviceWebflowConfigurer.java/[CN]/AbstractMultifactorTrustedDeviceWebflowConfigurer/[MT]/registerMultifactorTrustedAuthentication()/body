{
  if (flowDefinitionRegistry.getFlowDefinitionCount() <= 0) {
    throw new IllegalArgumentException("Flow definition registry has no flow definitions");
  }
  logger.debug("Flow definitions found in the registry are {}",flowDefinitionRegistry.getFlowDefinitionIds());
  final String flowId=Arrays.stream(flowDefinitionRegistry.getFlowDefinitionIds()).findFirst().get();
  logger.debug("Processing flow definition {}",flowId);
  final Flow flow=(Flow)flowDefinitionRegistry.getFlowDefinition(flowId);
  final ActionState state=(ActionState)flow.getState(CasWebflowConstants.STATE_ID_INIT_LOGIN_FORM);
  final Transition transition=(Transition)state.getTransition(CasWebflowConstants.TRANSITION_ID_SUCCESS);
  final String targetStateId=transition.getTargetStateId();
  transition.setTargetStateResolver(new DefaultTargetStateResolver(CasWebflowConstants.STATE_ID_VERIFY_TRUSTED_DEVICE));
  final ActionState verifyAction=createActionState(flow,CasWebflowConstants.STATE_ID_VERIFY_TRUSTED_DEVICE,createEvaluateAction("mfaVerifyTrustAction"));
  createTransitionForState(verifyAction,CasWebflowConstants.TRANSITION_ID_YES,CasWebflowConstants.TRANSITION_ID_REAL_SUBMIT);
  createTransitionForState(verifyAction,CasWebflowConstants.TRANSITION_ID_NO,targetStateId);
  if (enableDeviceRegistration) {
    final ActionState submit=(ActionState)flow.getState(CasWebflowConstants.TRANSITION_ID_REAL_SUBMIT);
    final Transition success=(Transition)submit.getTransition(CasWebflowConstants.TRANSITION_ID_SUCCESS);
    final String successTarget=success.getTargetStateId();
    success.setTargetStateResolver(new DefaultTargetStateResolver(CasWebflowConstants.STATE_ID_REGISTER_DEVICE));
    final ViewState viewRegister=createViewState(flow,CasWebflowConstants.STATE_ID_REGISTER_DEVICE,"casMfaRegisterDeviceView");
    viewRegister.getTransitionSet().add(createTransition(CasWebflowConstants.TRANSITION_ID_SUBMIT,successTarget));
  }
  final EndState endState=(EndState)flow.getState(CasWebflowConstants.STATE_ID_SUCCESS);
  endState.getEntryActionList().add(createEvaluateAction("mfaSetTrustAction"));
}
