{
  final Map<String,Object> attributes=authentication.getPrincipal().getAttributes();
  final Map<String,Object> authnAttributes=new TreeMap<String,Object>(authentication.getAttributes());
  final Object o=authnAttributes.get(RememberMeCredential.AUTHENTICATION_ATTRIBUTE_REMEMBER_ME);
  final boolean isRemembered=(o == Boolean.TRUE) && assertion.isFromNewLogin();
  if (isRemembered) {
    authnAttributes.remove(RememberMeCredential.AUTHENTICATION_ATTRIBUTE_REMEMBER_ME);
    authnAttributes.put(this.rememberMeAttributeName,Boolean.TRUE.toString());
  }
  final Map<String,Object> attributesToReturn=new HashMap<String,Object>();
  attributesToReturn.putAll(attributes);
  attributesToReturn.putAll(authnAttributes);
  return attributesToReturn;
}
