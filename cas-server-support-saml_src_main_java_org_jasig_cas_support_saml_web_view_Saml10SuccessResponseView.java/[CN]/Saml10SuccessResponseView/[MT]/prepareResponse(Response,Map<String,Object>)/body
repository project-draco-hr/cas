{
  final org.jasig.cas.validation.Assertion casAssertion=getAssertionFrom(model);
  final Authentication authentication=casAssertion.getChainedAuthentications().get(0);
  final DateTime issuedAt=response.getIssueInstant();
  final Service service=getAssertionFrom(model).getService();
  final Assertion assertion=newSamlObject(Assertion.class);
  assertion.setID(generateId());
  assertion.setIssueInstant(issuedAt);
  assertion.setIssuer(this.issuer);
  assertion.setConditions(newConditions(issuedAt,service.getId()));
  final AuthenticationStatement authnStatement=newAuthenticationStatement(authentication);
  assertion.getAuthenticationStatements().add(authnStatement);
  final Subject subject=newSubject(authentication.getPrincipal().getId());
  final Map<String,Object> attributesToSend=prepareSamlAttributes(authentication,casAssertion,service);
  if (!attributesToSend.isEmpty()) {
    assertion.getAttributeStatements().add(newAttributeStatement(subject,attributesToSend));
  }
  response.setStatus(newStatus(StatusCode.SUCCESS,null));
  response.getAssertions().add(assertion);
}
