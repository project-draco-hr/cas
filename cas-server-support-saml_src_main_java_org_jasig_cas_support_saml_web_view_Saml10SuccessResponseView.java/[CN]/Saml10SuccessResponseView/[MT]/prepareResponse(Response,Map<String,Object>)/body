{
  final DateTime issuedAt=response.getIssueInstant();
  final Service service=getAssertionFrom(model).getService();
  final Assertion assertion=newSamlObject(Assertion.class);
  assertion.setID(generateId());
  assertion.setIssueInstant(issuedAt);
  assertion.setIssuer(this.issuer);
  assertion.setConditions(newConditions(issuedAt,service.getId()));
  final AuthenticationStatement authnStatement=newAuthenticationStatement(model);
  assertion.getAuthenticationStatements().add(authnStatement);
  final Subject subject=newSubject(getPrincipal(model).getId());
  final Map<String,Object> attributesToSend=prepareSamlAttributes(model);
  if (!attributesToSend.isEmpty()) {
    assertion.getAttributeStatements().add(newAttributeStatement(subject,attributesToSend));
  }
  response.setStatus(newStatus(StatusCode.SUCCESS,null));
  response.getAssertions().add(assertion);
}
