{
  final AuthenticationResponse response;
  final UsernamePasswordCredentials upc=(UsernamePasswordCredentials)credential;
  try {
    log.debug("Attempting LDAP authentication for {}",credential);
    final AuthenticationRequest request=new AuthenticationRequest(upc.getUsername(),new Credential(upc.getPassword()),this.authenticatedEntryAttributes);
    response=this.authenticator.authenticate(request);
  }
 catch (  LdapException e) {
    throw new PreventedException("Unexpected LDAP error",e);
  }
  log.debug("LDAP response: {}",response);
  if (response.getResult()) {
    return new HandlerResult(this,createPrincipal(response.getLdapEntry()));
  }
  final AccountState state=response.getAccountState();
  if (state != null && state.getError() != null) {
    state.getError().throwSecurityException();
  }
  throw new FailedLoginException("LDAP authentication failed.");
}
