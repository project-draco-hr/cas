{
  final String id;
  if (this.principalIdAttribute != null) {
    final LdapAttribute principalAttr=ldapEntry.getAttribute(this.principalIdAttribute);
    if (principalAttr == null || principalAttr.size() == 0) {
      throw new LoginException(this.principalIdAttribute + " attribute not found for " + username);
    }
    if (principalAttr.size() > 1) {
      if (this.allowMultiplePrincipalAttributeValues) {
        logger.warn("Found multiple values for principal ID attribute: {}. Using first value={}.",principalAttr,principalAttr.getStringValue());
      }
 else {
        throw new LoginException("Multiple principal values not allowed: " + principalAttr);
      }
    }
    id=principalAttr.getStringValue();
  }
 else {
    id=username;
  }
  final Map<String,Object> attributeMap=new LinkedHashMap<String,Object>(this.principalAttributeMap.size());
  for (  final Map.Entry<String,String> ldapAttr : this.principalAttributeMap.entrySet()) {
    final LdapAttribute attr=ldapEntry.getAttribute(ldapAttr.getKey());
    if (attr != null) {
      logger.debug("Found principal attribute: {}",attr);
      final String principalAttrName=ldapAttr.getValue();
      if (attr.size() > 1) {
        attributeMap.put(principalAttrName,attr.getStringValues());
      }
 else {
        attributeMap.put(principalAttrName,attr.getStringValue());
      }
    }
  }
  return this.principalFactory.createPrincipal(id,attributeMap);
}
