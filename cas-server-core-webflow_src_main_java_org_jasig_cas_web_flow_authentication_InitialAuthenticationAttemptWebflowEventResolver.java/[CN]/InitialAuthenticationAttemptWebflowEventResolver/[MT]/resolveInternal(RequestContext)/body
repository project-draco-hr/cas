{
  try {
    final Credential credential=getCredentialFromContext(context);
    final AuthenticationResultBuilder builder=this.authenticationSystemSupport.handleInitialAuthenticationTransaction(credential);
    WebUtils.putAuthenticationResultBuilder(builder,context);
    WebUtils.putAuthentication(builder.getInitialAuthentication(),context);
    final Service service=WebUtils.getService(context);
    if (service != null) {
      final RegisteredService registeredService=this.servicesManager.findServiceBy(service);
      RegisteredServiceAccessStrategySupport.ensureServiceAccessIsAllowed(service,registeredService);
      final Set<Event> roleEvents=registeredServicePrincipalAttributeAuthenticationPolicyWebflowEventResolver.resolve(context);
      final Set<Event> attributeEvents=principalAttributeAuthenticationPolicyWebflowEventResolver.resolve(context);
      final Event event=registeredServiceAuthenticationPolicyWebflowEventResolver.resolveSingle(context);
      final ImmutableSet.Builder<Event> eventBuilder=ImmutableSet.builder();
      if (event != null) {
        eventBuilder.add(event);
      }
      if (roleEvents != null) {
        eventBuilder.addAll(roleEvents);
      }
      if (attributeEvents != null) {
        eventBuilder.addAll(attributeEvents);
      }
      final Set<Event> resolvedEvents=eventBuilder.build();
    }
    return ImmutableSet.of(grantTicketGrantingTicketToAuthenticationResult(context,builder,service));
  }
 catch (  final Exception e) {
    Event event=returnAuthenticationExceptionEventIfNeeded(e);
    if (event == null) {
      logger.debug(e.getMessage(),e);
      event=newEvent(CasWebflowConstants.TRANSITION_ID_ERROR,e);
    }
    return ImmutableSet.of(event);
  }
}
