{
  request.addParameter("openid.assoc_handle","test");
  openIdService=new OpenIdServiceFactory().createService(request);
  Association association=null;
  try {
    association=Association.generate(Association.TYPE_HMAC_SHA1,"test",2);
  }
 catch (  final Exception e) {
    fail("Could not generate association");
  }
  when(sharedAssociations.load("test")).thenReturn(association);
synchronized (this) {
    try {
      this.wait(3000);
    }
 catch (    final InterruptedException ie) {
      fail("Could not wait long enough to check association expiry date");
    }
  }
  final Response response=this.openIdService.getResponse("test");
  request.removeParameter("openid.assoc_handle");
  assertNotNull(response);
  assertEquals(1,response.getAttributes().size());
  assertEquals("cancel",response.getAttributes().get("openid.mode"));
}
