{
  HttpServletRequest request=WebUtils.getHttpServletRequest(context);
  HttpSession session=request.getSession();
  String providerType=request.getParameter(OAUTH_PROVIDER);
  logger.debug("providerType : {}",providerType);
  if (StringUtils.isNotBlank(providerType)) {
    OAuthProvider provider=null;
    for (    OAuthProvider aProvider : providers) {
      if (StringUtils.equals(providerType,aProvider.getType())) {
        provider=aProvider;
        break;
      }
    }
    logger.debug("provider : {}",provider);
    @SuppressWarnings("unchecked") OAuthCredential credential=provider.getCredential(request.getParameterMap());
    logger.debug("credential : {}",credential);
    Service service=(Service)session.getAttribute("service");
    context.getFlowScope().put("service",service);
    Credentials credentials=new OAuthCredentials(credential);
    try {
      WebUtils.putTicketGrantingTicketInRequestScope(context,this.centralAuthenticationService.createTicketGrantingTicket(credentials));
      return success();
    }
 catch (    final TicketException e) {
      return error();
    }
  }
 else {
    Service service=(Service)context.getFlowScope().get("service");
    session.setAttribute("service",service);
    for (    OAuthProvider provider : providers) {
      String key=provider.getType() + "Url";
      String authorizatonUrl=provider.getAuthorizationUrl(new HttpUserSession(session));
      logger.debug("{} -> {}",key,authorizatonUrl);
      request.setAttribute(key,authorizatonUrl);
    }
  }
  return error();
}
