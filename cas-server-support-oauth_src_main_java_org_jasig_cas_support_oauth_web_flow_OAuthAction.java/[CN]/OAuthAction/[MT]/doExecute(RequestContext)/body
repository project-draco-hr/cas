{
  final HttpServletRequest request=WebUtils.getHttpServletRequest(context);
  final HttpSession session=request.getSession();
  final String providerType=request.getParameter(OAuthConstants.OAUTH_PROVIDER);
  log.debug("providerType : {}",providerType);
  if (StringUtils.isNotBlank(providerType)) {
    final OAuthProvider provider=OAuthUtils.getProviderByType(this.configuration.getProviders(),providerType);
    log.debug("provider : {}",provider);
    @SuppressWarnings("unchecked") final OAuthCredential credential=provider.getCredential(new HttpUserSession(request),request.getParameterMap());
    log.debug("credential : {}",credential);
    final Service service=(Service)session.getAttribute(OAuthConstants.SERVICE);
    context.getFlowScope().put(OAuthConstants.SERVICE,service);
    restoreRequestAttribute(request,session,OAuthConstants.THEME);
    restoreRequestAttribute(request,session,OAuthConstants.LOCALE);
    restoreRequestAttribute(request,session,OAuthConstants.METHOD);
    final Credentials credentials=new OAuthCredentials(credential);
    try {
      WebUtils.putTicketGrantingTicketInRequestScope(context,this.centralAuthenticationService.createTicketGrantingTicket(credentials));
      return success();
    }
 catch (    final TicketException e) {
      return error();
    }
  }
 else {
    final Service service=(Service)context.getFlowScope().get(OAuthConstants.SERVICE);
    if (service != null) {
      session.setAttribute(OAuthConstants.SERVICE,service);
    }
    saveRequestParameter(request,session,OAuthConstants.THEME);
    saveRequestParameter(request,session,OAuthConstants.LOCALE);
    saveRequestParameter(request,session,OAuthConstants.METHOD);
    for (    final OAuthProvider provider : this.configuration.getProviders()) {
      final String key=provider.getType() + "Url";
      String authorizationUrl=null;
      if (provider instanceof BaseOAuth10Provider) {
        authorizationUrl=OAuthUtils.addParameter(request.getContextPath() + this.oauth10loginUrl,OAuthConstants.OAUTH_PROVIDER,provider.getType());
      }
 else {
        authorizationUrl=provider.getAuthorizationUrl(new HttpUserSession(session));
      }
      log.debug("{} -> {}",key,authorizationUrl);
      context.getFlowScope().put(key,authorizationUrl);
    }
  }
  return error();
}
