{
  final AuthenticationBuilder builder=new AuthenticationBuilder(NullPrincipal.getInstance());
  for (  final Credential c : credentials) {
    builder.addCredential(new BasicCredentialMetaData(c));
  }
  boolean found;
  Principal principal;
  PrincipalResolver resolver;
  for (  final Credential credential : credentials) {
    found=false;
    for (    final Map.Entry<AuthenticationHandler,PrincipalResolver> entry : this.handlerResolverMap.entrySet()) {
      final AuthenticationHandler theHandler=entry.getKey();
      if (theHandler.supports(credential)) {
        found=true;
        try {
          final HandlerResult result=theHandler.authenticate(credential);
          builder.addSuccess(theHandler.getName(),result);
          logger.info("{} successfully authenticated {}",theHandler.getName(),credential);
          resolver=entry.getValue();
          if (resolver == null) {
            principal=result.getPrincipal();
            logger.debug("No resolver configured for {}. Falling back to handler principal {}",theHandler.getName(),principal);
          }
 else {
            principal=resolvePrincipal(theHandler.getName(),resolver,credential);
          }
          if (principal != null) {
            builder.setPrincipal(principal);
          }
          if (this.authenticationPolicy.isSatisfiedBy(builder.build())) {
            return builder;
          }
        }
 catch (        final GeneralSecurityException e) {
          logger.info("{} failed authenticating {}",theHandler.getName(),credential);
          logger.debug("{} exception details: {}",theHandler.getName(),e.getMessage());
          builder.addFailure(theHandler.getName(),e.getClass());
        }
catch (        final PreventedException e) {
          logger.error("{}: {}  (Details: {})",theHandler.getName(),e.getMessage(),e.getCause().getMessage());
          builder.addFailure(theHandler.getName(),e.getClass());
        }
      }
    }
    if (!found) {
      logger.warn("Cannot find authentication handler that supports {}, which suggests a configuration problem.",credential);
    }
  }
  if (builder.getSuccesses().isEmpty()) {
    throw new AuthenticationException(builder.getFailures(),builder.getSuccesses());
  }
  if (!this.authenticationPolicy.isSatisfiedBy(builder.build())) {
    throw new AuthenticationException(builder.getFailures(),builder.getSuccesses());
  }
  return builder;
}
