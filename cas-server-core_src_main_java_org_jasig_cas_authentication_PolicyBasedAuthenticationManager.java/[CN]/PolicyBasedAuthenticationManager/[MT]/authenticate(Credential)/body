{
  final AuthenticationBuilder builder=authenticateInternal(credentials);
  final Authentication authentication=builder.build();
  final Principal principal=authentication.getPrincipal();
  if (principal instanceof NullPrincipal) {
    throw new UnresolvedPrincipalException(authentication);
  }
  for (  final HandlerResult result : authentication.getSuccesses().values()) {
    builder.addAttribute(AUTHENTICATION_METHOD_ATTRIBUTE,result.getHandlerName());
  }
  logger.info("Authenticated {} with credentials {}.",principal,Arrays.asList(credentials));
  logger.debug("Attribute map for {}: {}",principal.getId(),principal.getAttributes());
  for (  final AuthenticationMetaDataPopulator populator : this.authenticationMetaDataPopulators) {
    for (    final Credential credential : credentials) {
      populator.populateAttributes(builder,credential);
    }
  }
  return builder.build();
}
