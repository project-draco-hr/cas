{
  logger.debug("Finalizing authentication transactions and issuing ticket-granting ticket");
  final AuthenticationResult authenticationResult=authenticationSystemSupport.finalizeAllAuthenticationTransactions(authenticationResultBuilder,service);
  final Authentication authentication=authenticationResult.getAuthentication();
  logger.debug("Resulting final authentication is {} with principal {}",authentication,authentication.getPrincipal());
  final TicketGrantingTicket tgt=this.centralAuthenticationService.createTicketGrantingTicket(authenticationResult);
  WebUtils.putTicketGrantingTicketInScopes(context,tgt);
  WebUtils.putAuthenticationResult(authenticationResult,context);
  if (addWarningMessagesToMessageContextIfNeeded(tgt,context.getMessageContext())) {
    return newEvent(SUCCESS_WITH_WARNINGS);
  }
  return newEvent(CasWebflowConstants.TRANSITION_ID_SUCCESS);
}
