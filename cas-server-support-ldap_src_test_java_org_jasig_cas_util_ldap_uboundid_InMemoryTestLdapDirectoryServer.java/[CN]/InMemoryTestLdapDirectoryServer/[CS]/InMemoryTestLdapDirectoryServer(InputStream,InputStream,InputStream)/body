{
  try {
    final Properties p=new Properties();
    p.load(properties);
    final InMemoryDirectoryServerConfig config=new InMemoryDirectoryServerConfig(p.getProperty("ldap.rootDn"));
    config.addAdditionalBindCredentials(p.getProperty("ldap.managerDn"),p.getProperty("ldap.managerPassword"));
    final File keystoreFile=File.createTempFile("key","store");
    try (final OutputStream outputStream=new FileOutputStream(keystoreFile)){
      IOUtils.copy(new ClassPathResource("/ldapServerTrustStore").getInputStream(),outputStream);
    }
     final String serverKeyStorePath=keystoreFile.getCanonicalPath();
    final SSLUtil serverSSLUtil=new SSLUtil(new KeyStoreKeyManager(serverKeyStorePath,"changeit".toCharArray()),new TrustStoreTrustManager(serverKeyStorePath));
    final SSLUtil clientSSLUtil=new SSLUtil(new TrustStoreTrustManager(serverKeyStorePath));
    config.setListenerConfigs(InMemoryListenerConfig.createLDAPConfig("LDAP",null,1389,serverSSLUtil.createSSLSocketFactory()),InMemoryListenerConfig.createLDAPSConfig("LDAPS",null,1636,serverSSLUtil.createSSLServerSocketFactory(),clientSSLUtil.createSSLSocketFactory()));
    config.setEnforceSingleStructuralObjectClass(false);
    config.setEnforceAttributeSyntaxCompliance(true);
    final File file=File.createTempFile("ldap","schema");
    try (final OutputStream outputStream=new FileOutputStream(file)){
      IOUtils.copy(schemaFile,outputStream);
    }
     final Schema s=Schema.mergeSchemas(Schema.getSchema(file));
    config.setSchema(s);
    this.directoryServer=new InMemoryDirectoryServer(config);
    LOGGER.debug("Populating directory...");
    final File ldif=File.createTempFile("ldiff","file");
    try (final OutputStream outputStream=new FileOutputStream(ldif)){
      IOUtils.copy(ldifFile,outputStream);
    }
     this.directoryServer.importFromLDIF(true,ldif.getCanonicalPath());
    this.directoryServer.startListening();
    final LDAPConnection c=getConnection();
    LOGGER.debug("Connected to {}:{}",c.getConnectedAddress(),c.getConnectedPort());
    populateDefaultEntries(c);
    c.close();
  }
 catch (  final Exception e) {
    throw new RuntimeException(e);
  }
}
