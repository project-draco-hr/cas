{
  final SpnegoCredentials spnegoCredentials=(SpnegoCredentials)credentials;
  Principal principal;
  byte[] nextToken;
  try {
synchronized (this) {
      this.authentication.reset();
      this.authentication.process(spnegoCredentials.getInitToken());
      principal=this.authentication.getPrincipal();
      nextToken=this.authentication.getNextToken();
    }
  }
 catch (  jcifs.spnego.AuthenticationException e) {
    throw new BadCredentialsAuthenticationException(e);
  }
  if (nextToken != null) {
    logger.debug("Setting nextToken in credentials");
    spnegoCredentials.setNextToken(nextToken);
  }
 else {
    logger.debug("nextToken is null");
  }
  if (principal != null) {
    if (spnegoCredentials.isNtlm()) {
      logger.debug("NTLM Credentials is valid for user [{}]",principal.getName());
      spnegoCredentials.setPrincipal(getSimplePrincipal(principal.getName(),true));
      return this.isNTLMallowed;
    }
    logger.debug("Kerberos Credentials is valid for user [{}]",principal.getName());
    spnegoCredentials.setPrincipal(getSimplePrincipal(principal.getName(),false));
    return true;
  }
  logger.debug("Principal is null, the processing of the SPNEGO Token failed");
  return false;
}
