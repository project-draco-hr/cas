{
  final StringBuilder builder=new StringBuilder(parameters.size() * 40 + 100);
  boolean isFirst=true;
  final String[] fragmentSplit=url.split("#");
  builder.append(fragmentSplit[0]);
  for (  final Map.Entry<String,String> entry : parameters.entrySet()) {
    if (entry.getValue() != null) {
      if (isFirst) {
        builder.append(url.contains("?") ? "&" : "?");
        isFirst=false;
      }
 else {
        builder.append("&");
      }
      builder.append(entry.getKey());
      builder.append("=");
      try {
        builder.append(URLEncoder.encode(entry.getValue(),"UTF-8"));
      }
 catch (      final Exception e) {
        builder.append(entry.getValue());
      }
    }
  }
  if (fragmentSplit.length > 1) {
    builder.append("#");
    builder.append(fragmentSplit[1]);
  }
  return new Response(ResponseType.REDIRECT,builder.toString(),parameters);
}
