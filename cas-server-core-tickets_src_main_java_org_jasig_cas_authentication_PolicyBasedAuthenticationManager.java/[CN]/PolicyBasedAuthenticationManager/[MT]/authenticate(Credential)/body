{
  final AuthenticationBuilder builder=authenticateInternal(credentials);
  final Authentication authentication=builder.build();
  final Principal principal=authentication.getPrincipal();
  if (principal instanceof NullPrincipal) {
    throw new UnresolvedPrincipalException(authentication);
  }
  addAuthenticationMethodAttribute(builder,authentication);
  logger.info("Authenticated {} with credentials {}.",principal,Arrays.asList(credentials));
  logger.debug("Attribute map for {}: {}",principal.getId(),principal.getAttributes());
  populateAuthenticationMetadataAttributes(builder,credentials);
  return builder.build();
}
