{
  final RegisteredServiceImpl r=new RegisteredServiceImpl();
  r.setName("testSaveAttributeReleasePolicyAllowedAttrRulesWithCaching");
  r.setServiceId("testId");
  final ReturnAllowedAttributeReleasePolicy policy=new ReturnAllowedAttributeReleasePolicy();
  policy.setAllowedAttributes(Arrays.asList("1","2","3"));
  final Map<String,List<Object>> attributes=new HashMap<>();
  attributes.put("values",Arrays.asList(new Object[]{"v1","v2","v3"}));
  final CachingPrincipalAttributesRepository repository=new CachingPrincipalAttributesRepository(new StubPersonAttributeDao(attributes),TimeUnit.MILLISECONDS,100);
  repository.setMergingStrategy(new ReplacingAttributeAdder());
  policy.setPrincipalAttributesRepository(repository);
  r.setAttributeReleasePolicy(policy);
  final RegisteredService r2=this.dao.save(r);
  final RegisteredService r3=this.dao.findServiceById(r2.getId());
  assertEquals(r,r2);
  assertEquals(r2,r3);
  assertNotNull(r3.getAttributeReleasePolicy());
  assertEquals(r2.getAttributeReleasePolicy(),r3.getAttributeReleasePolicy());
}
