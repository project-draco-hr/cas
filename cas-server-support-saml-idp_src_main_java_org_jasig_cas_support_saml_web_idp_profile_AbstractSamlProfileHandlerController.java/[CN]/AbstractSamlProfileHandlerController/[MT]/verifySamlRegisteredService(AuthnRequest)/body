{
  final String serviceId=authnRequest.getAssertionConsumerServiceURL();
  final RegisteredService registeredService=this.servicesManager.findServiceBy(this.webApplicationServiceFactory.createService(serviceId));
  if (registeredService == null || !registeredService.getAccessStrategy().isServiceAccessAllowed()) {
    throw new UnauthorizedServiceException(UnauthorizedServiceException.CODE_UNAUTHZ_SERVICE);
  }
  if (registeredService instanceof SamlRegisteredService) {
    final SamlRegisteredService samlRegisteredService=(SamlRegisteredService)registeredService;
    logger.debug("Located SAML service in the registry as {} with the metadata location of {}",samlRegisteredService.getServiceId(),samlRegisteredService.getMetadataLocation());
    return samlRegisteredService;
  }
  logger.error("Service {} is found in registry but it is not a SAML service",serviceId);
  throw new UnauthorizedServiceException(UnauthorizedServiceException.CODE_UNAUTHZ_SERVICE);
}
