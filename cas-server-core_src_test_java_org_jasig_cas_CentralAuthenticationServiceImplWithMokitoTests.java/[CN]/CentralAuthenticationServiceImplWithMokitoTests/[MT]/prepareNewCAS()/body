{
  this.authentication=mock(Authentication.class);
  when(this.authentication.getAuthenticatedDate()).thenReturn(new Date());
  final CredentialMetaData metadata=new BasicCredentialMetaData(TestUtils.getCredentialsWithSameUsernameAndPassword("principal"));
  final Map<String,HandlerResult> successes=new HashMap<String,HandlerResult>();
  successes.put("handler1",new HandlerResult(mock(AuthenticationHandler.class),metadata));
  when(this.authentication.getCredentials()).thenReturn(Arrays.asList(metadata));
  when(this.authentication.getSuccesses()).thenReturn(successes);
  when(this.authentication.getPrincipal()).thenReturn(new SimplePrincipal(PRINCIPAL));
  final Service service1=TestUtils.getService(SVC1_ID);
  final ServiceTicket stMock=createMockServiceTicket(ST_ID,service1);
  final TicketGrantingTicket tgtRootMock=createRootTicketGrantingTicket();
  final TicketGrantingTicket tgtMock=createMockTicketGrantingTicket(TGT_ID,stMock,false,tgtRootMock,new ArrayList<Authentication>());
  final List<Authentication> authnListMock=mock(List.class);
  when(authnListMock.size()).thenReturn(2);
  when(authnListMock.get(anyInt())).thenReturn(this.authentication);
  when(tgtMock.getChainedAuthentications()).thenReturn(authnListMock);
  when(stMock.getGrantingTicket()).thenReturn(tgtMock);
  final Service service2=TestUtils.getService(SVC2_ID);
  final ServiceTicket stMock2=createMockServiceTicket(ST2_ID,service2);
  final TicketGrantingTicket tgtMock2=createMockTicketGrantingTicket(TGT2_ID,stMock2,false,tgtRootMock,authnListMock);
  final TicketRegistry ticketRegMock=mock(TicketRegistry.class);
  when(ticketRegMock.getTicket(eq(tgtMock.getId()),eq(TicketGrantingTicket.class))).thenReturn(tgtMock);
  when(ticketRegMock.getTicket(eq(tgtMock2.getId()),eq(TicketGrantingTicket.class))).thenReturn(tgtMock2);
  when(ticketRegMock.getTicket(eq(stMock.getId()),eq(ServiceTicket.class))).thenReturn(stMock);
  when(ticketRegMock.getTicket(eq(stMock2.getId()),eq(ServiceTicket.class))).thenReturn(stMock2);
  final RegisteredService mockRegSvc1=createMockRegisteredService(service1.getId(),true,getServiceProxyPolicy(false));
  final RegisteredService mockRegSvc2=createMockRegisteredService("test",false,getServiceProxyPolicy(true));
  final RegisteredService mockRegSvc3=createMockRegisteredService(service2.getId(),true,getServiceProxyPolicy(true));
  final ServicesManager smMock=mock(ServicesManager.class);
  when(smMock.findServiceBy(argThat(new VerifyServiceByIdMatcher(service1.getId())))).thenReturn(mockRegSvc1);
  when(smMock.findServiceBy(argThat(new VerifyServiceByIdMatcher("test")))).thenReturn(mockRegSvc2);
  when(smMock.findServiceBy(argThat(new VerifyServiceByIdMatcher(service2.getId())))).thenReturn(mockRegSvc3);
  final Map ticketIdGenForServiceMock=mock(Map.class);
  when(ticketIdGenForServiceMock.containsKey(any())).thenReturn(true);
  when(ticketIdGenForServiceMock.get(any())).thenReturn(new DefaultUniqueTicketIdGenerator());
  this.cas=new CentralAuthenticationServiceImpl(ticketRegMock,null,mock(AuthenticationManager.class),mock(UniqueTicketIdGenerator.class),ticketIdGenForServiceMock,mock(ExpirationPolicy.class),mock(ExpirationPolicy.class),smMock,mock(LogoutManager.class));
}
