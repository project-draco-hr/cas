{
  logger.debug("Starting to encode attributes for release to service [{}]",service);
  final Map<String,Object> newEncodedAttributes=new HashMap<>(attributes);
  final Map<String,String> cachedAttributesToEncode=initialize(newEncodedAttributes);
  final RegisteredService registeredService=this.servicesManager.findServiceBy(service);
  if (registeredService != null && registeredService.getAccessStrategy().isServiceAccessAllowed()) {
    final Cipher cipher=initializeCipherBasedOnServicePublicKey(registeredService);
    if (cipher != null) {
      encodeAttributesInternal(newEncodedAttributes,cachedAttributesToEncode,cipher);
    }
 else {
      logger.warn("Cipher could not be initialized for service [{}]. No encryption was applied to attributes",service);
    }
  }
 else {
    logger.warn("Service [{}] is not found and/or enabled in the service registry.",service);
  }
  logger.debug("[{}] Encoded attributes are available for release to [{}]",newEncodedAttributes.size(),service);
  return newEncodedAttributes;
}
