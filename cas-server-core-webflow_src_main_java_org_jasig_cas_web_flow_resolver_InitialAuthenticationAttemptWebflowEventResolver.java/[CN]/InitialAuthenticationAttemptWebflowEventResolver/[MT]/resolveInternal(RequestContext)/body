{
  try {
    final Credential credential=getCredentialFromContext(context);
    final AuthenticationResultBuilder builder=this.authenticationSystemSupport.handleInitialAuthenticationTransaction(credential);
    WebUtils.putAuthenticationResultBuilder(builder,context);
    WebUtils.putAuthentication(builder.getInitialAuthentication(),context);
    final Service service=WebUtils.getService(context);
    if (service != null) {
      logger.debug("Locating service {} in service registry to determine authentication policy",service);
      final RegisteredService registeredService=this.servicesManager.findServiceBy(service);
      RegisteredServiceAccessStrategySupport.ensureServiceAccessIsAllowed(service,registeredService);
      logger.debug("Evaluating authentication policy for {} based on principal attribute requirements only when accessing {}",registeredService.getServiceId(),service);
      final Event serviceAttributeEvent=registeredServicePrincipalAttributeAuthenticationPolicyWebflowEventResolver.resolveSingle(context);
      logger.debug("Evaluating authentication policy based on principal attribute requirements for {}",service);
      final Event attributeEvent=principalAttributeAuthenticationPolicyWebflowEventResolver.resolveSingle(context);
      logger.debug("Evaluating authentication policy for {}",service);
      final Event serviceEvent=registeredServiceAuthenticationPolicyWebflowEventResolver.resolveSingle(context);
      final ImmutableSet.Builder<Event> eventBuilder=ImmutableSet.builder();
      if (serviceAttributeEvent != null) {
        eventBuilder.add(serviceAttributeEvent);
      }
      if (attributeEvent != null) {
        eventBuilder.add(attributeEvent);
      }
      if (serviceEvent != null) {
        eventBuilder.add(serviceEvent);
      }
      final Set<Event> resolvedEvents=eventBuilder.build();
      if (!resolvedEvents.isEmpty()) {
        putResolvedEventsAsAttribute(context,resolvedEvents);
        final Event finalResolvedEvent=selectiveAuthenticationProviderWebflowEventResolver.resolveSingle(context);
        if (finalResolvedEvent != null) {
          return ImmutableSet.of(finalResolvedEvent);
        }
      }
    }
    return ImmutableSet.of(grantTicketGrantingTicketToAuthenticationResult(context,builder,service));
  }
 catch (  final Exception e) {
    Event event=returnAuthenticationExceptionEventIfNeeded(e);
    if (event == null) {
      logger.debug(e.getMessage(),e);
      event=newEvent(CasWebflowConstants.TRANSITION_ID_ERROR,e);
    }
    return ImmutableSet.of(event);
  }
}
