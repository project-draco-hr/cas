{
  final Map<String,String> parameters=new HashMap<String,String>();
  if (ticketId != null) {
    final ServerManager manager=(ServerManager)ApplicationContextProvider.getApplicationContext().getBean("serverManager");
    final CentralAuthenticationService cas=ApplicationContextProvider.getApplicationContext().getBean("centralAuthenticationService",CentralAuthenticationService.class);
    boolean associated=false;
    boolean associationValid=true;
    try {
      final AuthRequest authReq=AuthRequest.createAuthRequest(requestParameters,manager.getRealmVerifier());
      final Map parameterMap=authReq.getParameterMap();
      if (parameterMap != null && parameterMap.size() > 0) {
        final String assocHandle=(String)parameterMap.get("openid.assoc_handle");
        if (assocHandle != null) {
          final Association association=manager.getSharedAssociations().load(assocHandle);
          if (association != null) {
            associated=true;
            if (association.hasExpired()) {
              associationValid=false;
            }
          }
        }
      }
    }
 catch (    final MessageException me) {
      LOGGER.error("Message exception : {}",me.getMessage(),me);
    }
    boolean successFullAuthentication=true;
    try {
      if (associated) {
        if (associationValid) {
          cas.validateServiceTicket(ticketId,this);
          LOGGER.info("Validated openid ticket");
        }
 else {
          successFullAuthentication=false;
        }
      }
    }
 catch (    final TicketException te) {
      LOGGER.error("Could not validate ticket : {}",te.getMessage(),te);
      successFullAuthentication=false;
    }
    final Message response=manager.authResponse(requestParameters,this.identity,this.identity,successFullAuthentication,true);
    parameters.putAll(response.getParameterMap());
    if (!associated) {
      parameters.put("openid.assoc_handle",ticketId);
    }
  }
 else {
    parameters.put("openid.mode","cancel");
  }
  return Response.getRedirectResponse(getOriginalUrl(),parameters);
}
