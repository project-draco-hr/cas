{
  try {
    final AssertionConsumerService assertionConsumerService=getAssertionConsumerServiceFor(authnRequest);
    final CriteriaSet criterions=new CriteriaSet();
    criterions.add(new BindingCriterion(Collections.singletonList(SAMLConstants.SAML2_POST_BINDING_URI)));
    criterions.add(new EntityIdCriterion(registeredService.getEntityId()));
    criterions.add(new EndpointCriterion<>(assertionConsumerService,true));
    final EntityDescriptor entityDescriptor=registeredService.getChainingMetadataResolver().resolveSingle(criterions);
    if (entityDescriptor == null) {
      throw new SAMLException("Cannot find entity " + assertionConsumerService.getLocation() + " in metadata provider");
    }
    final SPSSODescriptor ssoDescriptor=entityDescriptor.getSPSSODescriptor(SAMLConstants.SAML20P_NS);
    return new SamlMetadataAdaptor(assertionConsumerService,ssoDescriptor);
  }
 catch (  final Exception e) {
    throw new RuntimeException(e.getMessage(),e);
  }
}
