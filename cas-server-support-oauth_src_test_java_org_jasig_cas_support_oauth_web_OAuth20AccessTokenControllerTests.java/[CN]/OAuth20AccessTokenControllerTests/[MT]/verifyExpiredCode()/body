{
  clearAllServices();
  final RegisteredService registeredService=getRegisteredService(REDIRECT_URI,CLIENT_SECRET);
  oAuth20AccessTokenController.getServicesManager().save(registeredService);
  final Map<String,Object> map=new HashMap<>();
  map.put(NAME,VALUE);
  final List<String> list=Arrays.asList(VALUE,VALUE);
  map.put(NAME2,list);
  final Principal principal=org.jasig.cas.authentication.TestUtils.getPrincipal(ID,map);
  final Authentication authentication=new OAuthAuthentication(new DateTime(),principal);
  final DefaultOAuthCodeFactory expiringOAuthCodeFactory=new DefaultOAuthCodeFactory();
  expiringOAuthCodeFactory.setExpirationPolicy(new ExpirationPolicy(){
    @Override public boolean isExpired(    final TicketState ticketState){
      return true;
    }
  }
);
  final Service service=new OAuthWebApplicationService("" + registeredService.getId(),registeredService.getServiceId());
  final OAuthCodeImpl code=(OAuthCodeImpl)expiringOAuthCodeFactory.create(service,authentication);
  oAuth20AccessTokenController.getTicketRegistry().addTicket(code);
  final MockHttpServletRequest mockRequest=new MockHttpServletRequest("GET",CONTEXT + OAuthConstants.ACCESS_TOKEN_URL);
  mockRequest.setParameter(OAuthConstants.CLIENT_ID,CLIENT_ID);
  mockRequest.setParameter(OAuthConstants.REDIRECT_URI,REDIRECT_URI);
  mockRequest.setParameter(OAuthConstants.CLIENT_SECRET,CLIENT_SECRET);
  mockRequest.setParameter(OAuthConstants.CODE,code.getId());
  final MockHttpServletResponse mockResponse=new MockHttpServletResponse();
  oAuth20AccessTokenController.handleRequest(mockRequest,mockResponse);
  assertEquals(400,mockResponse.getStatus());
  assertEquals("error=" + OAuthConstants.INVALID_GRANT,mockResponse.getContentAsString());
}
