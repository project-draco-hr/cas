{
  final MockHttpServletRequest mockRequest=new MockHttpServletRequest("GET",CONTEXT + OAuthConstants.ACCESS_TOKEN_URL);
  mockRequest.setParameter(OAuthConstants.CLIENT_ID,CLIENT_ID);
  mockRequest.setParameter(OAuthConstants.REDIRECT_URI,REDIRECT_URI);
  mockRequest.setParameter(OAuthConstants.CLIENT_SECRET,CLIENT_SECRET);
  mockRequest.setParameter(OAuthConstants.CODE,CODE);
  final MockHttpServletResponse mockResponse=new MockHttpServletResponse();
  final ServicesManager servicesManager=mock(ServicesManager.class);
  final RegisteredServiceImpl registeredServiceImpl=new RegisteredServiceImpl();
  registeredServiceImpl.setName(CLIENT_ID);
  registeredServiceImpl.setServiceId(REDIRECT_URI);
  registeredServiceImpl.setDescription(CLIENT_SECRET);
  final List<RegisteredService> services=new ArrayList<RegisteredService>();
  services.add(registeredServiceImpl);
  when(servicesManager.getAllServices()).thenReturn(services);
  final TicketRegistry ticketRegistry=mock(TicketRegistry.class);
  when(ticketRegistry.getTicket(CODE)).thenReturn(null);
  final OAuth20WrapperController oauth20WrapperController=new OAuth20WrapperController();
  oauth20WrapperController.setServicesManager(servicesManager);
  oauth20WrapperController.setTicketRegistry(ticketRegistry);
  oauth20WrapperController.afterPropertiesSet();
  final Logger log=mock(Logger.class);
  OAuth20AccessTokenController.setLogger(log);
  oauth20WrapperController.handleRequest(mockRequest,mockResponse);
  assertEquals(400,mockResponse.getStatus());
  assertEquals("error=" + OAuthConstants.INVALID_GRANT,mockResponse.getContentAsString());
  verify(log).error("Code expired : {}",CODE);
}
