{
  try {
    final HttpServletRequest request=WebUtils.getHttpServletRequest(context);
    final HttpSession session=request.getSession();
    final String wa=request.getParameter(WA);
    if (StringUtils.isNotBlank(wa) && wa.equalsIgnoreCase(WSIGNIN)) {
      final String wresult=request.getParameter(WRESULT);
      LOGGER.debug("Parameter [{}] received: {}",WRESULT,wresult);
      if (StringUtils.isBlank(wresult)) {
        LOGGER.error("No {} parameter is found",WRESULT);
        return error();
      }
      final Assertion assertion=this.wsFederationHelper.parseTokenFromString(wresult,configuration);
      if (assertion == null) {
        LOGGER.error("Could not validate assertion via parsing the token from {}",WRESULT);
        return error();
      }
      if (!this.wsFederationHelper.validateSignature(assertion,this.configuration)) {
        LOGGER.error("WS Requested Security Token is blank or the signature is not valid.");
        return error();
      }
      try {
        final Service service=(Service)session.getAttribute(SERVICE);
        final WsFederationCredential credential=this.wsFederationHelper.createCredentialFromToken(assertion);
        if (credential != null && credential.isValid(getRelyingPartyIdentifier(service),this.configuration.getIdentityProviderIdentifier(),this.configuration.getTolerance())) {
          if (this.configuration.getAttributeMutator() != null) {
            this.configuration.getAttributeMutator().modifyAttributes(credential.getAttributes());
          }
        }
 else {
          logger.warn("SAML assertions are blank or no longer valid.");
          final String authorizationUrl=String.format("%s%s%s",this.configuration.getIdentityProviderUrl(),QUERYSTRING,getRelyingPartyIdentifier(service));
          context.getFlowScope().put(PROVIDERURL,authorizationUrl);
          return error();
        }
        context.getFlowScope().put(SERVICE,service);
        restoreRequestAttribute(request,session,THEME);
        restoreRequestAttribute(request,session,LOCALE);
        restoreRequestAttribute(request,session,METHOD);
        final AuthenticationResult authenticationResult=this.authenticationSystemSupport.handleAndFinalizeSingleAuthenticationTransaction(service,credential);
        WebUtils.putTicketGrantingTicketInScopes(context,this.centralAuthenticationService.createTicketGrantingTicket(authenticationResult));
        LOGGER.info("Token validated and new {} created: {}",credential.getClass().getName(),credential);
        return success();
      }
 catch (      final AbstractTicketException e) {
        LOGGER.error(e.getMessage(),e);
        return error();
      }
    }
 else {
      final Service service=(Service)context.getFlowScope().get(SERVICE);
      if (service != null) {
        session.setAttribute(SERVICE,service);
      }
      saveRequestParameter(request,session,THEME);
      saveRequestParameter(request,session,LOCALE);
      saveRequestParameter(request,session,METHOD);
      final String relyingPartyIdentifier=getRelyingPartyIdentifier(service);
      final String authorizationUrl=this.configuration.getIdentityProviderUrl() + QUERYSTRING + relyingPartyIdentifier;
      LOGGER.info("Preparing to redirect to the IdP {}",authorizationUrl);
      context.getFlowScope().put(PROVIDERURL,authorizationUrl);
    }
    LOGGER.debug("Redirecting to the IdP");
    return error();
  }
 catch (  final Exception ex) {
    LOGGER.error(ex.getMessage(),ex);
    return error();
  }
}
