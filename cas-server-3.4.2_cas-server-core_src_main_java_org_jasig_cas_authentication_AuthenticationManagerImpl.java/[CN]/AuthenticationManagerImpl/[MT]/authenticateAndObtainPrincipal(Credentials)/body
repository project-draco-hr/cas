{
  boolean foundSupported=false;
  boolean authenticated=false;
  AuthenticationHandler authenticatedClass=null;
  for (  final AuthenticationHandler authenticationHandler : this.authenticationHandlers) {
    if (authenticationHandler.supports(credentials)) {
      foundSupported=true;
      if (!authenticationHandler.authenticate(credentials)) {
        if (this.log.isInfoEnabled()) {
          this.log.info("AuthenticationHandler: " + authenticationHandler.getClass().getName() + " failed to authenticate the user which provided the following credentials: "+ credentials.toString());
        }
      }
 else {
        if (this.log.isInfoEnabled()) {
          this.log.info("AuthenticationHandler: " + authenticationHandler.getClass().getName() + " successfully authenticated the user which provided the following credentials: "+ credentials.toString());
        }
        authenticatedClass=authenticationHandler;
        authenticated=true;
        break;
      }
    }
  }
  if (!authenticated) {
    if (foundSupported) {
      throw BadCredentialsAuthenticationException.ERROR;
    }
    throw UnsupportedCredentialsException.ERROR;
  }
  foundSupported=false;
  for (  final CredentialsToPrincipalResolver credentialsToPrincipalResolver : this.credentialsToPrincipalResolvers) {
    if (credentialsToPrincipalResolver.supports(credentials)) {
      final Principal principal=credentialsToPrincipalResolver.resolvePrincipal(credentials);
      this.log.info("Resolved principal " + principal);
      if (this.log.isDebugEnabled()) {
        this.log.debug(String.format("Attribute map for %s: %s",principal,principal.getAttributes()));
      }
      foundSupported=true;
      if (principal != null) {
        return new Pair<AuthenticationHandler,Principal>(authenticatedClass,principal);
      }
    }
  }
  if (foundSupported) {
    if (this.log.isDebugEnabled()) {
      this.log.debug("CredentialsToPrincipalResolver found but no principal returned.");
    }
    throw BadCredentialsAuthenticationException.ERROR;
  }
  this.log.error("CredentialsToPrincipalResolver not found for " + credentials.getClass().getName());
  throw UnsupportedCredentialsException.ERROR;
}
