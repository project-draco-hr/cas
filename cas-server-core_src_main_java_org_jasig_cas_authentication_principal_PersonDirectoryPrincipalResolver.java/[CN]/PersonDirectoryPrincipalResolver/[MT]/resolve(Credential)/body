{
  log.debug("Attempting to resolve a principal...");
  String principalId=extractPrincipalId(credential);
  if (principalId == null) {
    return null;
  }
  log.debug("Creating SimplePrincipal for [{}]",principalId);
  final IPersonAttributes personAttributes=this.attributeRepository.getPerson(principalId);
  final Map<String,List<Object>> attributes;
  if (personAttributes == null) {
    attributes=null;
  }
 else {
    attributes=personAttributes.getAttributes();
  }
  if (attributes == null & !this.returnNullIfNoAttributes) {
    return new SimplePrincipal(principalId);
  }
  if (attributes == null) {
    return null;
  }
  final Map<String,Object> convertedAttributes=new HashMap<String,Object>();
  for (  final String key : attributes.keySet()) {
    final List<Object> values=attributes.get(key);
    if (key.equals(this.principalAttributeName)) {
      if (values.isEmpty()) {
        log.debug("{} is empty, using {} for principal",this.principalAttributeName,principalId);
      }
 else {
        principalId=values.get(0).toString();
        log.debug("Found principal attribute value {}",principalId);
        log.debug("Removing principal attribute {} from attribute map.",this.principalAttributeName);
      }
    }
 else {
      convertedAttributes.put(key,values.size() == 1 ? values.get(0) : values);
    }
  }
  return new SimplePrincipal(principalId,convertedAttributes);
}
