{
  try {
    final String uid=usernamePasswordCredentials.getUsername();
    final String otp=usernamePasswordCredentials.getPassword();
    if (YubicoClient.isValidOTPFormat(otp)) {
      final String publicId=YubicoClient.getPublicId(otp);
      if (this.registry.isYubiKeyRegisteredFor(uid,publicId)) {
        final YubicoResponse response=client.verify(otp);
        log.debug("YubiKey response status {} at {}",response.getStatus(),response.getTimestamp());
        return (response.getStatus() == YubicoResponseStatus.OK);
      }
 else {
        log.debug("YubiKey public id [{}] is not registered for user [{}]",publicId,uid);
      }
    }
 else {
      log.debug("Invalid OTP format [{}]",otp);
    }
    return false;
  }
 catch (  final Exception e) {
    throw new BadUsernameOrPasswordAuthenticationException(e);
  }
}
