{
  final Map<String,Object> attributes=new HashMap<String,Object>();
  final Map<String,Object> givenAttributes=principal.getAttributes();
  if (registeredService.isIgnoreAttributes()) {
    logger.debug("Service [{}] is set to ignore attribute release policy. Releasing all attributes.",registeredService.getName());
    attributes.putAll(givenAttributes);
  }
 else {
    for (    final String attribute : registeredService.getAllowedAttributes()) {
      final Object value=givenAttributes.get(attribute);
      if (value != null) {
        logger.debug("Found attribute [{}] in the list of allowed attributes for service [{}]",attribute,registeredService.getName());
        attributes.put(attribute,value);
      }
    }
    if (registeredService.getAttributeFilter() != null) {
      return registeredService.getAttributeFilter().filter(principal.getId(),attributes);
    }
  }
  return Collections.unmodifiableMap(attributes);
}
