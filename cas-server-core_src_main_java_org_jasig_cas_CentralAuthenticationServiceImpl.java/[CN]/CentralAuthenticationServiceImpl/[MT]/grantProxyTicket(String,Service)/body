{
  final ProxyGrantingTicket proxyGrantingTicketObject=getTicket(proxyGrantingTicket,ProxyGrantingTicket.class);
  final RegisteredService registeredService=this.servicesManager.findServiceBy(service);
  try {
    RegisteredServiceAccessStrategySupport.ensurePrincipalAccessIsAllowedForService(service,registeredService,proxyGrantingTicketObject);
    RegisteredServiceAccessStrategySupport.ensureServiceSsoAccessIsAllowed(registeredService,service,proxyGrantingTicketObject);
  }
 catch (  final PrincipalException e) {
    throw new UnauthorizedSsoServiceException();
  }
  evaluateProxiedServiceIfNeeded(service,proxyGrantingTicketObject,registeredService);
  getAuthenticationSatisfiedByPolicy(proxyGrantingTicketObject.getRoot(),new ServiceContext(service,registeredService));
  final List<Authentication> authentications=proxyGrantingTicketObject.getChainedAuthentications();
  final Principal principal=authentications.get(authentications.size() - 1).getPrincipal();
  final ProxyTicketFactory factory=this.ticketFactory.get(ProxyTicket.class);
  final ProxyTicket proxyTicket=factory.create(proxyGrantingTicketObject,service);
  this.ticketRegistry.updateTicket(proxyGrantingTicketObject);
  this.ticketRegistry.addTicket(proxyTicket);
  logger.info("Granted ticket [{}] for service [{}] for user [{}]",proxyTicket.getId(),service.getId(),principal.getId());
  doPublishEvent(new CasProxyTicketGrantedEvent(this,proxyGrantingTicketObject,proxyTicket));
  return proxyTicket;
}
