{
  Assert.notNull(ticketGrantingTicketId,"ticketGrantingticketId cannot be null");
  Assert.notNull(service,"service cannot be null");
  final TicketGrantingTicket ticketGrantingTicket=(TicketGrantingTicket)this.ticketRegistry.getTicket(ticketGrantingTicketId,TicketGrantingTicket.class);
  if (ticketGrantingTicket == null) {
    throw new InvalidTicketException();
  }
synchronized (ticketGrantingTicket) {
    if (ticketGrantingTicket.isExpired()) {
      this.ticketRegistry.deleteTicket(ticketGrantingTicketId);
      throw new InvalidTicketException();
    }
  }
  final RegisteredService registeredService=this.servicesManager.findServiceBy(service);
  if (registeredService == null || !registeredService.isEnabled()) {
    log.warn("ServiceManagement: Unauthorized Service Access. Service [" + service.getId() + "] not found in Service Registry.");
    throw new UnauthorizedServiceException();
  }
  if (!registeredService.isSsoEnabled() && credentials == null && ticketGrantingTicket.getCountOfUses() > 0) {
    log.warn("ServiceManagement: Service Not Allowed to use SSO.  Service [" + service.getId() + "]");
    throw new UnauthorizedSsoServiceException();
  }
  final List<Authentication> authns=ticketGrantingTicket.getChainedAuthentications();
  if (authns.size() > 1) {
    if (!registeredService.isAllowedToProxy()) {
      final String message=String.format("ServiceManagement: Service Attempted to Proxy, but is not allowed. Service: [%s] | Registered Service: [%s]",service.getId(),registeredService.toString());
      log.warn(message);
      throw new UnauthorizedProxyingException(message);
    }
  }
  if (credentials != null) {
    final Authentication authentication=this.authenticationManager.authenticate(credentials);
    final Authentication originalAuthentication=ticketGrantingTicket.getAuthentication();
    if (!(authentication.getPrincipal().equals(originalAuthentication.getPrincipal()) && authentication.getAttributes().equals(originalAuthentication.getAttributes()))) {
      throw new TicketCreationException();
    }
  }
  final UniqueTicketIdGenerator serviceTicketUniqueTicketIdGenerator=this.uniqueTicketIdGeneratorsForService.get(service.getClass().getName());
  final ServiceTicket serviceTicket=ticketGrantingTicket.grantServiceTicket(serviceTicketUniqueTicketIdGenerator.getNewTicketId(ServiceTicket.PREFIX),service,this.serviceTicketExpirationPolicy,credentials != null);
  this.serviceTicketRegistry.addTicket(serviceTicket);
  if (log.isInfoEnabled()) {
    final List<Authentication> authentications=serviceTicket.getGrantingTicket().getChainedAuthentications();
    final String formatString="Granted %s ticket [%s] for service [%s] for user [%s]";
    final String type;
    final String principalId=authentications.get(authentications.size() - 1).getPrincipal().getId();
    if (authentications.size() == 1) {
      type="service";
    }
 else {
      type="proxy";
    }
    log.info(String.format(formatString,type,serviceTicket.getId(),service.getId(),principalId));
  }
  return serviceTicket.getId();
}
