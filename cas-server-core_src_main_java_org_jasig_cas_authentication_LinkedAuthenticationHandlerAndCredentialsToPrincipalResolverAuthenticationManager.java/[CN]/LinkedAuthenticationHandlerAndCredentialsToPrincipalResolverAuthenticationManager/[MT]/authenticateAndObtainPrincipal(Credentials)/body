{
  boolean foundOneThatWorks=false;
  String handlerName;
  AuthenticationException authException=BadCredentialsAuthenticationException.ERROR;
  for (  final AuthenticationHandler authenticationHandler : this.linkedHandlers.keySet()) {
    if (!authenticationHandler.supports(credentials)) {
      continue;
    }
    foundOneThatWorks=true;
    boolean authenticated=false;
    handlerName=authenticationHandler.getClass().getName();
    try {
      authenticationHandler.authenticate(credentials);
      authenticated=true;
    }
 catch (    final GeneralSecurityException e) {
      logAuthenticationHandlerError(handlerName,credentials,e);
    }
catch (    final PreventedException e) {
      logAuthenticationHandlerError(handlerName,credentials,e);
    }
    if (authenticated) {
      log.info("{} successfully authenticated {}",handlerName,credentials);
      final Principal p=this.linkedHandlers.get(authenticationHandler).resolvePrincipal(credentials);
      return new Pair<AuthenticationHandler,Principal>(authenticationHandler,p);
    }
    log.info("{} failed to authenticate {}",handlerName,credentials);
  }
  if (foundOneThatWorks) {
    throw authException;
  }
  throw UnsupportedCredentialsException.ERROR;
}
