{
  final Lock lock;
  try {
    lock=entityManager.find(Lock.class,applicationId,LockModeType.PESSIMISTIC_WRITE);
  }
 catch (  final PersistenceException e) {
    logger.debug("{} failed querying for {} lock.",uniqueId,applicationId,e);
    return false;
  }
  boolean result=false;
  if (lock != null) {
    final ZonedDateTime expDate=ZonedDateTime.from(lock.getExpirationDate());
    if (lock.getUniqueId() == null) {
      logger.debug("{} trying to acquire {} lock.",uniqueId,applicationId);
      result=acquire(entityManager,lock);
    }
 else     if (ZonedDateTime.now(ZoneOffset.UTC).isAfter(expDate)) {
      logger.debug("{} trying to acquire expired {} lock.",uniqueId,applicationId);
      result=acquire(entityManager,lock);
    }
  }
 else {
    logger.debug("Creating {} lock initially held by {}.",applicationId,uniqueId);
    result=acquire(entityManager,new Lock());
  }
  return result;
}
