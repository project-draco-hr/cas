{
  boolean foundSupported=false;
  boolean authenticated=false;
  AuthenticationHandler authenticatedClass=null;
  String handlerName;
  AuthenticationException unAuthSupportedHandlerException=BadCredentialsAuthenticationException.ERROR;
  for (  final AuthenticationHandler authenticationHandler : this.authenticationHandlers) {
    if (authenticationHandler.supports(credentials)) {
      foundSupported=true;
      handlerName=authenticationHandler.getClass().getName();
      try {
        if (!authenticationHandler.authenticate(credentials)) {
          logger.info("{} failed to authenticate {}",handlerName,credentials);
        }
 else {
          logger.info("{} successfully authenticated {}",handlerName,credentials);
          authenticatedClass=authenticationHandler;
          authenticated=true;
          break;
        }
      }
 catch (      AuthenticationException e) {
        unAuthSupportedHandlerException=e;
        logAuthenticationHandlerError(handlerName,credentials,e);
      }
catch (      Exception e) {
        logAuthenticationHandlerError(handlerName,credentials,e);
      }
    }
  }
  if (!authenticated) {
    if (foundSupported) {
      throw unAuthSupportedHandlerException;
    }
    throw UnsupportedCredentialsException.ERROR;
  }
  foundSupported=false;
  for (  final CredentialsToPrincipalResolver credentialsToPrincipalResolver : this.credentialsToPrincipalResolvers) {
    if (credentialsToPrincipalResolver.supports(credentials)) {
      final Principal principal=credentialsToPrincipalResolver.resolvePrincipal(credentials);
      logger.info("Resolved principal {}",principal);
      foundSupported=true;
      if (principal != null) {
        return new Pair<AuthenticationHandler,Principal>(authenticatedClass,principal);
      }
    }
  }
  if (foundSupported) {
    logger.debug("CredentialsToPrincipalResolver found but no principal returned.");
    throw BadCredentialsAuthenticationException.ERROR;
  }
  logger.error("CredentialsToPrincipalResolver not found for {}",credentials.getClass().getName());
  throw UnsupportedCredentialsException.ERROR;
}
