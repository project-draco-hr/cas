{
  final MockHttpServletRequest mockRequest=new MockHttpServletRequest("GET",CONTEXT + OAuthConstants.AUTHORIZE_URL);
  mockRequest.setParameter(OAuthConstants.CLIENT_ID,CLIENT_ID);
  mockRequest.setParameter(OAuthConstants.REDIRECT_URI,REDIRECT_URI);
  mockRequest.setServerName(CAS_SERVER);
  mockRequest.setServerPort(CAS_PORT);
  mockRequest.setScheme(CAS_SCHEME);
  final MockHttpServletResponse mockResponse=new MockHttpServletResponse();
  final ServicesManager servicesManager=mock(ServicesManager.class);
  final List<RegisteredService> services=new ArrayList<>();
  services.add(getRegisteredService(REDIRECT_URI,SERVICE_NAME));
  when(servicesManager.getAllServices()).thenReturn(services);
  final OAuth20WrapperController oauth20WrapperController=new OAuth20WrapperController();
  oauth20WrapperController.setLoginUrl(CAS_URL);
  oauth20WrapperController.setServicesManager(servicesManager);
  final ModelAndView modelAndView=oauth20WrapperController.handleRequest(mockRequest,mockResponse);
  final HttpSession session=mockRequest.getSession();
  assertEquals(REDIRECT_URI,session.getAttribute(OAuthConstants.OAUTH20_CALLBACKURL));
  assertEquals(SERVICE_NAME,session.getAttribute(OAuthConstants.OAUTH20_SERVICE_NAME));
  final View view=modelAndView.getView();
  assertTrue(view instanceof RedirectView);
  final RedirectView redirectView=(RedirectView)view;
  final MockHttpServletRequest reqSvc=new MockHttpServletRequest("GET",CONTEXT + OAuthConstants.CALLBACK_AUTHORIZE_URL);
  reqSvc.setServerName(CAS_SERVER);
  reqSvc.setServerPort(CAS_PORT);
  reqSvc.setScheme(CAS_SCHEME);
  final URL url=new URL(OAuthUtils.addParameter(CAS_URL,"service",reqSvc.getRequestURL().toString()));
  final URL url2=new URL(redirectView.getUrl());
  assertEquals(url,url2);
}
