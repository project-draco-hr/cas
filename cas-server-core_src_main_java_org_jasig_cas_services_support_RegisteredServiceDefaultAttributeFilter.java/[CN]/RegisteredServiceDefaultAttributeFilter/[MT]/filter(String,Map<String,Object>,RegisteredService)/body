{
  final Map<String,Object> attributes=new HashMap<String,Object>();
  if (registeredService.isIgnoreAttributes()) {
    log.debug("Service [{}] is set to ignore attribute release policy. Releasing all attributes.",registeredService.getName());
    attributes.putAll(givenAttributes);
  }
 else {
    for (    final String attribute : registeredService.getAllowedAttributes()) {
      final Object value=givenAttributes.get(attribute);
      if (value != null) {
        log.debug("Found attribute [{}] in the list of allowed attributes for service [{}]",attribute,registeredService.getName());
        attributes.put(attribute,value);
      }
    }
  }
  return Collections.unmodifiableMap(filterInternal(principalId,attributes,registeredService));
}
